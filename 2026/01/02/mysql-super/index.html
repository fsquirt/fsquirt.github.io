
<!DOCTYPE html><html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.33.1" theme-name="Stellar" theme-version="1.33.1">
  
  
  <meta name="generator" content="Hexo 8.1.1">
  <meta http-equiv='x-dns-prefetch-control' content='on' />
  
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000">
  <meta name="theme-color" content="#f9fafb">
  <title>Mysqlæ”»ç•¥-é«˜çº§æŸ¥è¯¢åˆ°è¿›é˜¶åŠŸèƒ½ - cloudyou</title>

  
    <meta name="description" content="ä½ ç‚¹å¼€æœ¬æ–‡æˆ‘å°±å½“ä½ å·²ç»çŸ¥é“MysqlåŸºç¡€äº†ï¼Œçœ‹å®Œæœ¬æ–‡ä½ å°†é€Ÿé€šï¼šå‡½æ•°ï¼Œåˆ†ç»„ä¸ç»Ÿè®¡ï¼Œå¤šè¡¨æŸ¥è¯¢ï¼Œå­æŸ¥è¯¢ï¼Œç´¢å¼•ï¼Œäº‹åŠ¡ï¼Œé—´éš™é”ã€‚ ç”±äºç¯‡å¹…é—®é¢˜ï¼Œçª—å£å‡½æ•°ï¼Œæ‚²è§‚&#x2F;ä¹è§‚é”ï¼Œå¤„ç† JSON æ•°æ®ï¼Œå¤æ‚é€»è¾‘å¤„ç†(if else)ï¼Œæ€§èƒ½åˆ†æï¼Œå­˜å‚¨è¿‡ç¨‹ä¸è§¦å‘å™¨ç­‰ç­‰é«˜çº§åŠŸèƒ½ä¼šæ”¾åˆ°ä¸‹ä¸€ç¯‡æ–‡ç« ã€‚å…¨éƒ¨çœ‹å®Œä½ å°±ç¬é—´å˜æˆMysqlé«˜æ‰‹ å…ˆç”¨ä¸‹é¢çš„pyæ¨¡æ‹Ÿä¸€å †æ•°æ®è¿›å» 123456789101112131415161718">
<meta property="og:type" content="article">
<meta property="og:title" content="Mysqlæ”»ç•¥-é«˜çº§æŸ¥è¯¢åˆ°è¿›é˜¶åŠŸèƒ½">
<meta property="og:url" content="https://www.cloudyou.top/2026/01/02/mysql-super/">
<meta property="og:site_name" content="cloudyou">
<meta property="og:description" content="ä½ ç‚¹å¼€æœ¬æ–‡æˆ‘å°±å½“ä½ å·²ç»çŸ¥é“MysqlåŸºç¡€äº†ï¼Œçœ‹å®Œæœ¬æ–‡ä½ å°†é€Ÿé€šï¼šå‡½æ•°ï¼Œåˆ†ç»„ä¸ç»Ÿè®¡ï¼Œå¤šè¡¨æŸ¥è¯¢ï¼Œå­æŸ¥è¯¢ï¼Œç´¢å¼•ï¼Œäº‹åŠ¡ï¼Œé—´éš™é”ã€‚ ç”±äºç¯‡å¹…é—®é¢˜ï¼Œçª—å£å‡½æ•°ï¼Œæ‚²è§‚&#x2F;ä¹è§‚é”ï¼Œå¤„ç† JSON æ•°æ®ï¼Œå¤æ‚é€»è¾‘å¤„ç†(if else)ï¼Œæ€§èƒ½åˆ†æï¼Œå­˜å‚¨è¿‡ç¨‹ä¸è§¦å‘å™¨ç­‰ç­‰é«˜çº§åŠŸèƒ½ä¼šæ”¾åˆ°ä¸‹ä¸€ç¯‡æ–‡ç« ã€‚å…¨éƒ¨çœ‹å®Œä½ å°±ç¬é—´å˜æˆMysqlé«˜æ‰‹ å…ˆç”¨ä¸‹é¢çš„pyæ¨¡æ‹Ÿä¸€å †æ•°æ®è¿›å» 123456789101112131415161718">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://www.cloudyou.top/images/%E5%A4%B4%E5%83%8F.jpg">
<meta property="article:published_time" content="2026-01-02T14:53:43.000Z">
<meta property="article:modified_time" content="2026-01-04T11:09:52.442Z">
<meta property="article:author" content="å…³å°é›¨">
<meta property="article:tag" content="Database">
<meta property="article:tag" content="Mysql">
<meta property="article:tag" content="notebook">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://www.cloudyou.top/images/%E5%A4%B4%E5%83%8F.jpg">
  
  
  
  <meta name="keywords" content="Mysql,Database,notebook">

  <!-- feed -->
  

  <link rel="stylesheet" href="/css/main.css?v=1.33.1">


  

  

  <script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"å…³å°é›¨","sameAs":[],"image":"/images/å¤´åƒ.jpg"},"dateCreated":"2026-01-02T22:53:43+08:00","dateModified":"2026-01-04T19:09:52+08:00","datePublished":"2026-01-02T22:53:43+08:00","description":"","headline":"Mysqlæ”»ç•¥-é«˜çº§æŸ¥è¯¢åˆ°è¿›é˜¶åŠŸèƒ½","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.cloudyou.top/2026/01/02/mysql-super/"},"publisher":{"@type":"Organization","name":"å…³å°é›¨","sameAs":[],"image":"/images/å¤´åƒ.jpg","logo":{"@type":"ImageObject","url":"/images/å¤´åƒ.jpg"}},"url":"https://www.cloudyou.top/2026/01/02/mysql-super/","keywords":"Mysql, Database, notebook","thumbnailUrl":"/images/mysql2.png","image":1}</script>
  
</head>
<body>

<div class="l_body content" id="start" layout="post" type="tech" ><aside class="l_left"><div class="sidebg"></div><div class="leftbar-container">


<header class="header"><div class="logo-wrap"><a class="avatar" href="/about/"><div class="bg" style="opacity:0;background-image:url(https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/rainbow64@3x.webp);"></div><img no-lazy class="avatar" src="/images/å¤´åƒ.jpg" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/image/2659360.svg';"></a><a class="title" href="/"><div class="main">cloudyou</div><div class="sub normal cap">rm -rf /past && touch future</div><div class="sub hover cap" style="opacity:0"> åœ¨æ¯”ç‰¹çš„æ´ªæµä¸­ç›˜æ¡“æ­¤åˆ»</div></a></div></header>

<div class="nav-area">

<nav class="menu dis-select"></nav>
</div>
<div class="widgets">
<div class="search-wrapper" id="search-wrapper"><form class="search-form"><a class="search-button" onclick="document.getElementById(&quot;search-input&quot;).focus();"><svg t="1705074644177" viewBox="0 0 1025 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1560" width="200" height="200"><path d="M1008.839137 935.96571L792.364903 719.491476a56.783488 56.783488 0 0 0-80.152866 0 358.53545 358.53545 0 1 1 100.857314-335.166073 362.840335 362.840335 0 0 1-3.689902 170.145468 51.248635 51.248635 0 1 0 99.217358 26.444296 462.057693 462.057693 0 1 0-158.255785 242.303546l185.930047 185.725053a51.248635 51.248635 0 0 0 72.568068 0 51.248635 51.248635 0 0 0 0-72.978056z" p-id="1561"></path><path d="M616.479587 615.969233a50.428657 50.428657 0 0 0-61.498362-5.534852 174.655348 174.655348 0 0 1-177.525271 3.484907 49.403684 49.403684 0 0 0-58.833433 6.76482l-3.074918 2.869923a49.403684 49.403684 0 0 0 8.609771 78.10292 277.767601 277.767601 0 0 0 286.992355-5.739847 49.403684 49.403684 0 0 0 8.404776-76.667958z" p-id="1562"></path></svg></a><input type="text" class="search-input" id="search-input" placeholder="ç«™å†…æœç´¢"></form><div id="search-result"></div><div class="search-no-result">æ²¡æœ‰æ‰¾åˆ°å†…å®¹ï¼</div></div>



<widget class="widget-wrapper recent post-list"><div class="widget-header dis-select"><span class="name">æœ€è¿‘æ›´æ–°</span></div><div class="widget-body fs14"><a class="item title" href="/2026/01/04/mysql-higher/"><span class="title">Mysqlæ”»ç•¥-è¿›é˜¶åŠŸèƒ½åˆ°æ›´å¤š</span></a><a class="item title" href="/2026/01/02/mysql-super/"><span class="title">Mysqlæ”»ç•¥-é«˜çº§æŸ¥è¯¢åˆ°è¿›é˜¶åŠŸèƒ½</span></a><a class="item title" href="/2026/01/02/mysql-quick/"><span class="title">Mysqlæ”»ç•¥-å®‰è£…ä½¿ç”¨åˆ°åŸºç¡€çš„å¢åˆ æ”¹æŸ¥</span></a></div></widget>
</div>

</div></aside><div class="l_main" id="main">





<div class="article banner top"><img class="lazy bg" data-src="/images/mysql2.png">
  <div class="content">
    <div class="top bread-nav footnote"><div class="left"><div class="flex-row" id="breadcrumb"><a class="cap breadcrumb" href="/">ä¸»é¡µ</a>
<span class="sep"></span><a class="cap breadcrumb" href="/">æ–‡ç« </a></div>
<div class="flex-row" id="post-meta"><span class="text created">å‘å¸ƒäºï¼š<time datetime="2026-01-02T14:53:43.000Z">2026-01-02</time></span><span class="sep updated"></span><span class="text updated">æ›´æ–°äºï¼š<time datetime="2026-01-04T11:09:52.442Z">2026-01-04</time></span></div></div></div>
    
    <div class="bottom only-title">
      
      <div class="text-area">
        <h1 class="text title"><span>Mysqlæ”»ç•¥-é«˜çº§æŸ¥è¯¢åˆ°è¿›é˜¶åŠŸèƒ½</span></h1>
        
      </div>
    </div>
    
  </div>
  </div><article class="md-text content"><p>ä½ ç‚¹å¼€æœ¬æ–‡æˆ‘å°±å½“ä½ å·²ç»çŸ¥é“MysqlåŸºç¡€äº†ï¼Œçœ‹å®Œæœ¬æ–‡ä½ å°†é€Ÿé€šï¼šå‡½æ•°ï¼Œåˆ†ç»„ä¸ç»Ÿè®¡ï¼Œå¤šè¡¨æŸ¥è¯¢ï¼Œå­æŸ¥è¯¢ï¼Œç´¢å¼•ï¼Œäº‹åŠ¡ï¼Œé—´éš™é”ã€‚</p>
<p>ç”±äºç¯‡å¹…é—®é¢˜ï¼Œçª—å£å‡½æ•°ï¼Œæ‚²è§‚&#x2F;ä¹è§‚é”ï¼Œå¤„ç† JSON æ•°æ®ï¼Œå¤æ‚é€»è¾‘å¤„ç†(if else)ï¼Œæ€§èƒ½åˆ†æï¼Œå­˜å‚¨è¿‡ç¨‹ä¸è§¦å‘å™¨ç­‰ç­‰é«˜çº§åŠŸèƒ½ä¼šæ”¾åˆ°ä¸‹ä¸€ç¯‡æ–‡ç« ã€‚å…¨éƒ¨çœ‹å®Œä½ å°±ç¬é—´å˜æˆMysqlé«˜æ‰‹</p>
<p>å…ˆç”¨ä¸‹é¢çš„pyæ¨¡æ‹Ÿä¸€å †æ•°æ®è¿›å»</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"><span class="keyword">from</span> faker <span class="keyword">import</span> Faker</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="comment"># ================= é…ç½®åŒºåŸŸ =================</span></span><br><span class="line">DB_CONFIG = &#123;</span><br><span class="line">    <span class="string">&quot;host&quot;</span>: <span class="string">&quot;localhost&quot;</span>,</span><br><span class="line">    <span class="string">&quot;user&quot;</span>: <span class="string">&quot;root&quot;</span>,        </span><br><span class="line">    <span class="string">&quot;password&quot;</span>: <span class="string">&quot;123456&quot;</span>, <span class="comment"># âš ï¸ è®°å¾—æ”¹ä½ çš„å¯†ç </span></span><br><span class="line">    <span class="string">&quot;port&quot;</span>: <span class="number">3306</span>,</span><br><span class="line">    <span class="string">&quot;charset&quot;</span>: <span class="string">&quot;utf8mb4&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">DB_NAME = <span class="string">&quot;mall_db_simple&quot;</span> <span class="comment"># ä¾ç„¶ä½¿ç”¨çº¯å‡€åº“</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ•°æ®é‡è®¾ç½®</span></span><br><span class="line">NUM_USERS = <span class="number">200</span>     <span class="comment"># 200ä¸ªç”¨æˆ·</span></span><br><span class="line">NUM_PRODUCTS = <span class="number">50</span>   <span class="comment"># 50ç§å•†å“</span></span><br><span class="line">NUM_ORDERS = <span class="number">100</span>   <span class="comment"># 100ä¸ªè®¢å• (ç”Ÿæˆçš„ order_items ä¼šæœ‰ 2000~4000 æ¡)</span></span><br><span class="line"><span class="comment"># ===========================================</span></span><br><span class="line"></span><br><span class="line">fake = Faker(<span class="string">&quot;zh_CN&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_connection</span>(<span class="params">use_db=<span class="literal">True</span></span>):</span><br><span class="line">    conf = DB_CONFIG.copy()</span><br><span class="line">    <span class="keyword">if</span> use_db:</span><br><span class="line">        conf[<span class="string">&quot;db&quot;</span>] = DB_NAME</span><br><span class="line">    <span class="keyword">return</span> pymysql.connect(**conf)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init_db</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;ğŸ”„ åˆå§‹åŒ–çº¯å‡€ç‰ˆæ•°æ®åº“: <span class="subst">&#123;DB_NAME&#125;</span>...&quot;</span>)</span><br><span class="line">    conn = get_connection(use_db=<span class="literal">False</span>)</span><br><span class="line">    cursor = conn.cursor()</span><br><span class="line"></span><br><span class="line">    cursor.execute(<span class="string">f&quot;CREATE DATABASE IF NOT EXISTS <span class="subst">&#123;DB_NAME&#125;</span> DEFAULT CHARSET utf8mb4;&quot;</span>)</span><br><span class="line">    cursor.execute(<span class="string">f&quot;USE <span class="subst">&#123;DB_NAME&#125;</span>;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ¸…ç†æ—§è¡¨</span></span><br><span class="line">    cursor.execute(<span class="string">&quot;DROP TABLE IF EXISTS order_items;&quot;</span>)</span><br><span class="line">    cursor.execute(<span class="string">&quot;DROP TABLE IF EXISTS orders;&quot;</span>)</span><br><span class="line">    cursor.execute(<span class="string">&quot;DROP TABLE IF EXISTS products;&quot;</span>)</span><br><span class="line">    cursor.execute(<span class="string">&quot;DROP TABLE IF EXISTS users;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># === è¡¨ç»“æ„ä¿æŒâ€œç´ é¢œâ€ï¼ˆåªæœ‰ä¸»é”®ï¼‰ ===</span></span><br><span class="line"></span><br><span class="line">    sql_users = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    CREATE TABLE users (</span></span><br><span class="line"><span class="string">        id INT AUTO_INCREMENT PRIMARY KEY,</span></span><br><span class="line"><span class="string">        username VARCHAR(50),</span></span><br><span class="line"><span class="string">        email VARCHAR(100),</span></span><br><span class="line"><span class="string">        phone VARCHAR(20),</span></span><br><span class="line"><span class="string">        city VARCHAR(50),</span></span><br><span class="line"><span class="string">        created_at DATETIME</span></span><br><span class="line"><span class="string">    );</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    sql_products = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    CREATE TABLE products (</span></span><br><span class="line"><span class="string">        id INT AUTO_INCREMENT PRIMARY KEY,</span></span><br><span class="line"><span class="string">        name VARCHAR(100),</span></span><br><span class="line"><span class="string">        category VARCHAR(50),</span></span><br><span class="line"><span class="string">        price DECIMAL(10, 2),</span></span><br><span class="line"><span class="string">        stock INT,</span></span><br><span class="line"><span class="string">        status TINYINT</span></span><br><span class="line"><span class="string">    );</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    sql_orders = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    CREATE TABLE orders (</span></span><br><span class="line"><span class="string">        id INT AUTO_INCREMENT PRIMARY KEY,</span></span><br><span class="line"><span class="string">        user_id INT NOT NULL,</span></span><br><span class="line"><span class="string">        order_no VARCHAR(50),</span></span><br><span class="line"><span class="string">        total_amount DECIMAL(12, 2), -- è¿™ä¸ªé‡‘é¢æ˜¯ç»è¿‡è®¡ç®—ç®—å‡ºæ¥çš„</span></span><br><span class="line"><span class="string">        status TINYINT,</span></span><br><span class="line"><span class="string">        created_at DATETIME</span></span><br><span class="line"><span class="string">    );</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    sql_order_items = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    CREATE TABLE order_items (</span></span><br><span class="line"><span class="string">        id INT AUTO_INCREMENT PRIMARY KEY,</span></span><br><span class="line"><span class="string">        order_id INT NOT NULL,</span></span><br><span class="line"><span class="string">        product_id INT NOT NULL,</span></span><br><span class="line"><span class="string">        quantity INT,</span></span><br><span class="line"><span class="string">        price DECIMAL(10, 2)</span></span><br><span class="line"><span class="string">    );</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    cursor.execute(sql_users)</span><br><span class="line">    cursor.execute(sql_products)</span><br><span class="line">    cursor.execute(sql_orders)</span><br><span class="line">    cursor.execute(sql_order_items)</span><br><span class="line">    conn.commit()</span><br><span class="line">    conn.close()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;âœ… è¡¨ç»“æ„é‡ç½®å®Œæˆï¼&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_data</span>():</span><br><span class="line">    conn = get_connection()</span><br><span class="line">    cursor = conn.cursor()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- 1. ç”Ÿæˆç”¨æˆ· ---</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ğŸ‘¤ æ­£åœ¨ç”Ÿæˆç”¨æˆ·...&quot;</span>)</span><br><span class="line">    users_data = []</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(NUM_USERS):</span><br><span class="line">        users_data.append((fake.name(), fake.email(), fake.phone_number(), fake.city(), fake.date_time()))</span><br><span class="line">    cursor.executemany(<span class="string">&quot;INSERT INTO users (username, email, phone, city, created_at) VALUES (%s, %s, %s, %s, %s)&quot;</span>, users_data)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- 2. ç”Ÿæˆå•†å“ ---</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ğŸ“¦ æ­£åœ¨ç”Ÿæˆå•†å“...&quot;</span>)</span><br><span class="line">    products_data = []</span><br><span class="line">    <span class="comment"># æç‚¹çœŸå®çš„åˆ†ç±»</span></span><br><span class="line">    categories = [<span class="string">&#x27;æ•°ç &#x27;</span>, <span class="string">&#x27;é›¶é£Ÿ&#x27;</span>, <span class="string">&#x27;ä¹¦ç±&#x27;</span>, <span class="string">&#x27;æœè£…&#x27;</span>, <span class="string">&#x27;å®¶å±…&#x27;</span>]</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(NUM_PRODUCTS):</span><br><span class="line">        cat = random.choice(categories)</span><br><span class="line">        price = random.randint(<span class="number">10</span>, <span class="number">2000</span>) <span class="comment"># ä»·æ ¼åœ¨10å—åˆ°2000å—ä¹‹é—´</span></span><br><span class="line">        products_data.append((<span class="string">f&quot;<span class="subst">&#123;cat&#125;</span>-<span class="subst">&#123;fake.word()&#125;</span>&quot;</span>, cat, price, <span class="number">999</span>, <span class="number">1</span>))</span><br><span class="line">    cursor.executemany(<span class="string">&quot;INSERT INTO products (name, category, price, stock, status) VALUES (%s, %s, %s, %s, %s)&quot;</span>, products_data)</span><br><span class="line">    conn.commit()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å‡†å¤‡ç¼“å­˜æ•°æ®ï¼Œæ–¹ä¾¿ä¸‹é¢ç”Ÿæˆè®¢å•ç”¨</span></span><br><span class="line">    cursor.execute(<span class="string">&quot;SELECT id FROM users&quot;</span>)</span><br><span class="line">    user_ids = [r[<span class="number">0</span>] <span class="keyword">for</span> r <span class="keyword">in</span> cursor.fetchall()]</span><br><span class="line"></span><br><span class="line">    cursor.execute(<span class="string">&quot;SELECT id, price FROM products&quot;</span>)</span><br><span class="line">    <span class="comment"># å˜æˆå­—å…¸ &#123;id: price&#125;ï¼Œæ–¹ä¾¿æŸ¥ä»·æ ¼</span></span><br><span class="line">    products_map = &#123;r[<span class="number">0</span>]: <span class="built_in">float</span>(r[<span class="number">1</span>]) <span class="keyword">for</span> r <span class="keyword">in</span> cursor.fetchall()&#125; </span><br><span class="line">    product_ids_list = <span class="built_in">list</span>(products_map.keys())</span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- 3. ç”Ÿæˆå¤æ‚çš„è®¢å• ---</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ğŸ“ æ­£åœ¨ç”Ÿæˆå¤æ‚è®¢å• (å¤šå•†å“/å¤šæ•°é‡)...&quot;</span>)</span><br><span class="line">    batch_orders = []</span><br><span class="line">    batch_items = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, NUM_ORDERS + <span class="number">1</span>):</span><br><span class="line">        <span class="comment"># 3.1 éšæœºé€‰äººã€æ—¶é—´ã€çŠ¶æ€</span></span><br><span class="line">        u_id = random.choice(user_ids)</span><br><span class="line">        created_at = fake.date_time_between(start_date=<span class="string">&quot;-1y&quot;</span>, end_date=<span class="string">&quot;now&quot;</span>)</span><br><span class="line">        order_no = <span class="string">f&quot;ORD<span class="subst">&#123;created_at.strftime(<span class="string">&#x27;%Y%m%d&#x27;</span>)&#125;</span><span class="subst">&#123;i:05d&#125;</span>&quot;</span></span><br><span class="line">        status = random.choice([<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 3.2 å†³å®šè¿™ä¸ªè®¢å•ä¹°å‡ ç§å•†å“ (1 åˆ° 5 ç§)</span></span><br><span class="line">        items_count = random.randint(<span class="number">1</span>, <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ä»å•†å“åº“é‡ŒéšæœºæŠ½ items_count ä¸ªå•†å“ID (ä¸é‡å¤)</span></span><br><span class="line">        selected_pids = random.sample(product_ids_list, items_count)</span><br><span class="line"></span><br><span class="line">        current_order_total = <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 3.3 éå†ç”Ÿæˆçš„å•†å“ï¼Œç®—é’±ï¼Œç”Ÿæˆæ˜ç»†</span></span><br><span class="line">        <span class="keyword">for</span> pid <span class="keyword">in</span> selected_pids:</span><br><span class="line">            <span class="comment"># å†³å®šä¹°å‡ ä¸ª (1 åˆ° 3 ä¸ª)</span></span><br><span class="line">            qty = random.randint(<span class="number">1</span>, <span class="number">3</span>)</span><br><span class="line">            price = products_map[pid]</span><br><span class="line"></span><br><span class="line">            <span class="comment"># ç´¯åŠ æ€»é‡‘é¢</span></span><br><span class="line">            current_order_total += price * qty</span><br><span class="line"></span><br><span class="line">            <span class="comment"># æ·»åŠ åˆ° items åˆ—è¡¨ (æ³¨æ„è¿™é‡Œç”¨äº† i ä½œä¸º order_id)</span></span><br><span class="line">            batch_items.append((i, pid, qty, price))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 3.4 æ·»åŠ åˆ° orders åˆ—è¡¨</span></span><br><span class="line">        batch_orders.append((u_id, order_no, current_order_total, status, created_at))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ¯500ä¸ªæäº¤ä¸€æ¬¡ï¼Œé˜²æ­¢åˆ—è¡¨å¤ªå¤§æ’‘çˆ†å†…å­˜</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(batch_orders) &gt;= <span class="number">500</span>:</span><br><span class="line">            cursor.executemany(<span class="string">&quot;INSERT INTO orders (user_id, order_no, total_amount, status, created_at) VALUES (%s, %s, %s, %s, %s)&quot;</span>, batch_orders)</span><br><span class="line">            cursor.executemany(<span class="string">&quot;INSERT INTO order_items (order_id, product_id, quantity, price) VALUES (%s, %s, %s, %s)&quot;</span>, batch_items)</span><br><span class="line">            conn.commit()</span><br><span class="line">            batch_orders = []</span><br><span class="line">            batch_items = []</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;   ...å·²å¤„ç† <span class="subst">&#123;i&#125;</span> ä¸ªè®¢å•&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¤„ç†å‰©ä¸‹çš„</span></span><br><span class="line">    <span class="keyword">if</span> batch_orders:</span><br><span class="line">        cursor.executemany(<span class="string">&quot;INSERT INTO orders (user_id, order_no, total_amount, status, created_at) VALUES (%s, %s, %s, %s, %s)&quot;</span>, batch_orders)</span><br><span class="line">        cursor.executemany(<span class="string">&quot;INSERT INTO order_items (order_id, product_id, quantity, price) VALUES (%s, %s, %s, %s)&quot;</span>, batch_items)</span><br><span class="line">        conn.commit()</span><br><span class="line"></span><br><span class="line">    conn.close()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\nğŸ‰ æå®šï¼ç”Ÿæˆäº† <span class="subst">&#123;NUM_ORDERS&#125;</span> ä¸ªè®¢å•ï¼ŒåŒ…å«å¤šç§å•†å“ç»„åˆã€‚&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    init_db()</span><br><span class="line">    generate_data()</span><br></pre></td></tr></table></figure>

<h1 id="å‡½æ•°"><a href="#å‡½æ•°" class="headerlink" title="å‡½æ•°"></a>å‡½æ•°</h1><p>Mysqlæä¾›äº†å¾ˆå¤šç±»ä¼¼äºç¼–ç¨‹è¯­è¨€çš„å‡½æ•°ï¼Œè¿›æ¥ä¸€å †è¡Œï¼Œåå‡ºä¸€ä¸ªå€¼</p>
<table>
<thead>
<tr>
<th align="left">å‡½æ•°å</th>
<th align="left">ç±»å‹</th>
<th align="left">ä½œç”¨</th>
<th align="left">åº”ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>COUNT()</strong></td>
<td align="left">èšåˆ</td>
<td align="left">æ•°æ•°</td>
<td align="left">ç»Ÿè®¡ä»Šå¤©æœ‰å¤šå°‘äººæ³¨å†Œï¼š<code>COUNT(id)</code></td>
</tr>
<tr>
<td align="left"><strong>SUM()</strong></td>
<td align="left">èšåˆ</td>
<td align="left">æ±‚å’Œ</td>
<td align="left">ç®—å‡ºä»Šå¤©çš„æ€»è¥ä¸šé¢ï¼š<code>SUM(total_amount)</code></td>
</tr>
<tr>
<td align="left"><strong>AVG()</strong></td>
<td align="left">èšåˆ</td>
<td align="left">å¹³å‡å€¼</td>
<td align="left">ç®—å‡ºå®¢å•ä»·ï¼ˆå¹³å‡æ¯å•å¤šå°‘é’±ï¼‰ï¼š<code>AVG(total_amount)</code></td>
</tr>
<tr>
<td align="left"><strong>MAX()</strong></td>
<td align="left">èšåˆ</td>
<td align="left">æœ€å¤§å€¼</td>
<td align="left">æ‰¾å‡ºæœ€è´µçš„å•†å“ä»·æ ¼ï¼š<code>MAX(price)</code></td>
</tr>
<tr>
<td align="left"><strong>MIN()</strong></td>
<td align="left">èšåˆ</td>
<td align="left">æœ€å°å€¼</td>
<td align="left">æ‰¾å‡ºåº“å­˜æœ€å°‘çš„å•†å“ï¼š<code>MIN(stock)</code></td>
</tr>
<tr>
<td align="left"><strong>GROUP_CONCAT()</strong></td>
<td align="left">èšåˆ</td>
<td align="left">æ‹¼æ¥ç»“æœ</td>
<td align="left">æŠŠä¸€ä¸ªè®¢å•ä¹°çš„æ‰€æœ‰å•†å“åæ‹¼æˆä¸€è¡Œæ˜¾ç¤ºï¼š<code>&quot;è–¯ç‰‡,å¯ä¹,è¾£æ¡&quot;</code></td>
</tr>
<tr>
<td align="left"><strong>NOW()</strong></td>
<td align="left">æ—¶é—´</td>
<td align="left">å½“å‰æ—¶é—´</td>
<td align="left">æ’å…¥è®¢å•æ—¶ï¼Œ<code>created_at</code> å­—æ®µç”¨çš„å°±æ˜¯å®ƒ</td>
</tr>
<tr>
<td align="left"><strong>DATE_FORMAT()</strong></td>
<td align="left">æ—¶é—´</td>
<td align="left">æ ¼å¼åŒ–</td>
<td align="left">å‰ç«¯è¦æ˜¾ç¤º â€œ2026å¹´01æœˆ04æ—¥â€ï¼Œè€Œä¸æ˜¯æ•°æ®åº“é‚£ä¸²åŸæœ¬çš„è‹±æ–‡æ ¼å¼</td>
</tr>
<tr>
<td align="left"><strong>DATEDIFF()</strong></td>
<td align="left">æ—¶é—´</td>
<td align="left">ç®—å¤©æ•°</td>
<td align="left">ç»Ÿè®¡ç”¨æˆ· â€œæ³¨å†Œäº†å¤šå°‘å¤©â€ï¼š<code>DATEDIFF(NOW(), created_at)</code></td>
</tr>
<tr>
<td align="left"><strong>CONCAT()</strong></td>
<td align="left">å­—ç¬¦ä¸²</td>
<td align="left">æ‹¼å­—ç¬¦ä¸²</td>
<td align="left">æ¨¡ç³Šæœç´¢æ—¶æ‹¼ <code>like</code> æ¡ä»¶ï¼Œæˆ–è€…æŠŠ å§“+å æ‹¼åœ¨ä¸€èµ·</td>
</tr>
<tr>
<td align="left"><strong>SUBSTR()</strong></td>
<td align="left">å­—ç¬¦ä¸²</td>
<td align="left">æˆªå–</td>
<td align="left">æ‰‹æœºå·è„±æ•ï¼Œåªæ˜¾ç¤ºåå››ä½</td>
</tr>
<tr>
<td align="left"><strong>LENGTH()</strong></td>
<td align="left">å­—ç¬¦ä¸²</td>
<td align="left">ç®—é•¿åº¦</td>
<td align="left">æ£€æŸ¥ç”¨æˆ·ç®€ä»‹æ˜¯ä¸æ˜¯å¤ªé•¿äº†</td>
</tr>
<tr>
<td align="left"><strong>IFNULL()</strong></td>
<td align="left">é€»è¾‘</td>
<td align="left">æ˜¯ä¸æ˜¯NULL?</td>
<td align="left">å¦‚æœå¤´åƒ URL æ˜¯ <code>NULL</code>ï¼Œç»™ä¸ªé»˜è®¤å›¾ï¼š<code>IFNULL(avatar, &#39;default.png&#39;)</code></td>
</tr>
<tr>
<td align="left"><strong>CASE WHEN</strong></td>
<td align="left">é€»è¾‘</td>
<td align="left">SQLé‡Œçš„if-else</td>
<td align="left">æŠŠçŠ¶æ€ <code>0/1</code> è½¬æ¢æˆä¸­æ–‡ â€œæœªæ”¯ä»˜â€&#x2F;â€œå·²æ”¯ä»˜â€</td>
</tr>
</tbody></table>
<p>ä¸‹é¢çš„å†…å®¹ä¼šä½¿ç”¨åˆ°è¿™äº›å¸¸ç”¨çš„å‡½æ•°ï¼Œå¦‚æœæœ‰ç”¨åˆ°çš„å‡½æ•°æ²¡æœ‰åœ¨è¿™å¼ è¡¨ä¸Šæ˜¾ç¤ºçš„è¯ï¼Œå¯ä»¥å‰å¾€<a target="_blank" rel="noopener" href="https://www.runoob.com/mysql/mysql-functions.html">MySQL å‡½æ•° | èœé¸Ÿæ•™ç¨‹</a> æŸ¥çœ‹å‡½æ•°åŠŸèƒ½ </p>
<h1 id="åˆ†ç»„å’Œç»Ÿè®¡"><a href="#åˆ†ç»„å’Œç»Ÿè®¡" class="headerlink" title="åˆ†ç»„å’Œç»Ÿè®¡"></a>åˆ†ç»„å’Œç»Ÿè®¡</h1><p>GROUP BY è¯­å¥æ ¹æ®ä¸€ä¸ªæˆ–å¤šä¸ªåˆ—å¯¹ç»“æœé›†è¿›è¡Œåˆ†ç»„ã€‚</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    åˆ†ç»„å­—æ®µ, </span><br><span class="line">    èšåˆå‡½æ•°(ç»Ÿè®¡å­—æ®µ)</span><br><span class="line"><span class="keyword">FROM</span> è¡¨å</span><br><span class="line"><span class="keyword">WHERE</span> è¿‡æ»¤æ¡ä»¶              <span class="comment">-- (å¯é€‰) åœ¨åˆ†ç»„å‰è¿‡æ»¤åŸå§‹è¡Œ</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> åˆ†ç»„å­—æ®µ           <span class="comment">-- æ ¸å¿ƒï¼šæŒ‰ä»€ä¹ˆæ¥åˆ†ç»„</span></span><br><span class="line"><span class="keyword">HAVING</span> èšåˆåçš„è¿‡æ»¤æ¡ä»¶      <span class="comment">-- (å¯é€‰) åœ¨åˆ†ç»„åè¿‡æ»¤ç»Ÿè®¡ç»“æœ</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> æ’åºå­—æ®µ;          <span class="comment">-- (å¯é€‰) æ’åº</span></span><br></pre></td></tr></table></figure>

<h2 id="ä½¿ç”¨GROUP-BYåˆ†ç»„"><a href="#ä½¿ç”¨GROUP-BYåˆ†ç»„" class="headerlink" title="ä½¿ç”¨GROUP BYåˆ†ç»„"></a>ä½¿ç”¨GROUP BYåˆ†ç»„</h2><p>ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œæ¯”å¦‚æˆ‘æƒ³æŸ¥çœ‹mall_db_simpleæ•°æ®åº“é‡Œï¼Œproductsè¡¨é‡Œæœ‰å¤šå°‘ç§å•†å“ç±»å‹</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> category <span class="keyword">from</span> products <span class="keyword">group</span> <span class="keyword">by</span> category;</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·å°±ä¼šè¾“å‡º</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+----------+</span><br><span class="line">| category |</span><br><span class="line">+----------+</span><br><span class="line">| ä¹¦ç±     |</span><br><span class="line">| å®¶å±…     |</span><br><span class="line">| æ•°ç      |</span><br><span class="line">| æœè£…     |</span><br><span class="line">| é›¶é£Ÿ     |</span><br><span class="line">+----------+</span><br><span class="line">5 rows in set (0.0005 sec)</span><br></pre></td></tr></table></figure>

<h2 id="é…åˆå‡½æ•°ä½¿ç”¨"><a href="#é…åˆå‡½æ•°ä½¿ç”¨" class="headerlink" title="é…åˆå‡½æ•°ä½¿ç”¨"></a>é…åˆå‡½æ•°ä½¿ç”¨</h2><p>å¦‚æœæˆ‘è¿˜æƒ³çœ‹æ¯ä¸ªåˆ†ç±»æœ‰å¤šå°‘ä¸ªï¼Œä½¿ç”¨ä¸Šé¢æåˆ°çš„<code>COUNT()</code>å‡½æ•°æ¥è·å–ä¸ªæ•°</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> category,<span class="built_in">count</span>(category) <span class="keyword">from</span> products <span class="keyword">group</span> <span class="keyword">by</span> category;</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·å°±ä¼šè¾“å‡º</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+----------+-----------------+</span><br><span class="line">| category | count(category) |</span><br><span class="line">+----------+-----------------+</span><br><span class="line">| ä¹¦ç±     |               4 |</span><br><span class="line">| å®¶å±…     |              14 |</span><br><span class="line">| æ•°ç      |               8 |</span><br><span class="line">| æœè£…     |              15 |</span><br><span class="line">| é›¶é£Ÿ     |               9 |</span><br><span class="line">+----------+-----------------+</span><br><span class="line">5 rows in set (0.0009 sec)</span><br></pre></td></tr></table></figure>

<p>è¿”å›çš„çš„è¡¨ä¸ªæ•°åˆ—ä¼šä½¿ç”¨sqlè¯­å¥é‡Œå†™çš„å†…å®¹ï¼Œå¯ä»¥ä½¿ç”¨ <code>AS</code> å…³é”®å­—æ¥ç»™è¿™ä¸ªåˆ—å–ä¸ªåå­—</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> category,<span class="built_in">count</span>(category) <span class="keyword">as</span> category_count <span class="keyword">from</span> products <span class="keyword">group</span> <span class="keyword">by</span> category;</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·åˆ— <code>count(category)</code> å°±ä¼šè¢«é‡å‘½åä¸º <code>category_count</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+----------+----------------+</span><br><span class="line">| category | category_count |</span><br><span class="line">+----------+----------------+</span><br><span class="line">| ä¹¦ç±     |              4 |</span><br><span class="line">| å®¶å±…     |             14 |</span><br><span class="line">| æ•°ç      |              8 |</span><br><span class="line">| æœè£…     |             15 |</span><br><span class="line">| é›¶é£Ÿ     |              9 |</span><br><span class="line">+----------+----------------+</span><br><span class="line">5 rows in set (0.0003 sec)</span><br></pre></td></tr></table></figure>

<h2 id="ä½¿ç”¨HAVINGå¯¹åˆ†ç»„ä¹‹åçš„ç»“æœå†è¿‡æ»¤"><a href="#ä½¿ç”¨HAVINGå¯¹åˆ†ç»„ä¹‹åçš„ç»“æœå†è¿‡æ»¤" class="headerlink" title="ä½¿ç”¨HAVINGå¯¹åˆ†ç»„ä¹‹åçš„ç»“æœå†è¿‡æ»¤"></a>ä½¿ç”¨HAVINGå¯¹åˆ†ç»„ä¹‹åçš„ç»“æœå†è¿‡æ»¤</h2><p>æ¯”å¦‚æˆ‘è¦åˆ—å‡ºä¸ªæ•°å°äº10çš„å•†å“ï¼Œçœ‹çœ‹æˆ‘å•†åŸç½‘ç«™ä¸Šè¿˜æœ‰å“ªäº›å•†å“æ¯”è¾ƒç¼º</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> category,<span class="built_in">count</span>(category) <span class="keyword">as</span> category_count <span class="keyword">from</span> products <span class="keyword">group</span> <span class="keyword">by</span> category <span class="keyword">having</span> category_count <span class="operator">&lt;</span> <span class="number">10</span>;</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·å°±åªä¼šè¾“å‡ºå•†å“ç±»åˆ«å°äº10çš„å•†å“ç§ç±»</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+----------+----------------+</span><br><span class="line">| category | category_count |</span><br><span class="line">+----------+----------------+</span><br><span class="line">| ä¹¦ç±     |              4 |</span><br><span class="line">| æ•°ç      |              8 |</span><br><span class="line">| é›¶é£Ÿ     |              9 |</span><br><span class="line">+----------+----------------+</span><br><span class="line">3 rows in set (0.0042 sec)</span><br></pre></td></tr></table></figure>

<h3 id="HAVINGå’ŒWHEREçš„åŒºåˆ«ï¼Ÿ"><a href="#HAVINGå’ŒWHEREçš„åŒºåˆ«ï¼Ÿ" class="headerlink" title="HAVINGå’ŒWHEREçš„åŒºåˆ«ï¼Ÿ"></a>HAVINGå’ŒWHEREçš„åŒºåˆ«ï¼Ÿ</h3><p><strong><code>WHERE</code></strong>ï¼šåœ¨åˆ†ç»„<strong>ä¹‹å‰</strong>è¿‡æ»¤ã€‚æ¯”å¦‚ï¼šæˆ‘åªç»Ÿè®¡â€œå·²æ”¯ä»˜â€è®¢å•çš„é‡‘é¢ã€‚</p>
<p><strong><code>HAVING</code></strong>ï¼šåœ¨åˆ†ç»„<strong>ä¹‹å</strong>è¿‡æ»¤ç»Ÿè®¡ç»“æœã€‚æ¯”å¦‚ï¼šæˆ‘åªçœ‹â€œæ¶ˆè´¹æ€»é¢è¶…è¿‡1000å…ƒâ€çš„å¤§å®¢æˆ·ã€‚</p>
<p>ä¸Šé¢é‚£ä¸ªæŒ‡ä»¤ï¼Œå¦‚æœæŠŠhavingç§»åŠ¨åˆ°whereä½œä¸ºæ¡ä»¶å°±ä¼š</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> category,<span class="built_in">count</span>(category) <span class="keyword">as</span> category_count <span class="keyword">from</span> products <span class="keyword">where</span> category_count <span class="operator">&lt;</span> <span class="number">10</span> <span class="keyword">group</span> <span class="keyword">by</span> category ;</span><br></pre></td></tr></table></figure>

<p>æŠ¥é”™</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR: 1054 (42S22): Unknown column &#x27;category_count&#x27; in &#x27;where clause&#x27;</span><br></pre></td></tr></table></figure>

<p>WHEREä¼šæ‰¾ä¸åˆ°åˆ†ç»„åçš„è¿™ä¸€ä¸ªåˆ—</p>
<h1 id="å¤šè¡¨æŸ¥è¯¢"><a href="#å¤šè¡¨æŸ¥è¯¢" class="headerlink" title="å¤šè¡¨æŸ¥è¯¢"></a>å¤šè¡¨æŸ¥è¯¢</h1><p>åœ¨é‚£ä¸ªpyç”Ÿæˆçš„æ•°æ®åº“é‡Œï¼Œä¸ºäº†ä¸è®©æ•°æ®å†—ä½™ï¼Œæˆ‘æŠŠæ•°æ®æ‹†åˆ†åˆ°äº†ä¸åŒçš„è¡¨é‡Œï¼ˆç”¨æˆ·ä¸€å¼ è¡¨ã€è®¢å•ä¸€å¼ è¡¨ï¼‰ã€‚å¤šè¡¨æŸ¥è¯¢å°±æ˜¯é€šè¿‡ä¸€ä¸ª  <strong>â€œå…³è”å­—æ®µâ€</strong>ï¼ŒæŠŠè¿™äº›è¡¨åƒæ‹¼å›¾ä¸€æ ·ä¸´æ—¶æ‹¼èµ·æ¥ã€‚å°±æ˜¯å¤šè¡¨æŸ¥è¯¢</p>
<h2 id="ä½¿ç”¨JOINè¿›è¡Œå¤šè¡¨æŸ¥è¯¢"><a href="#ä½¿ç”¨JOINè¿›è¡Œå¤šè¡¨æŸ¥è¯¢" class="headerlink" title="ä½¿ç”¨JOINè¿›è¡Œå¤šè¡¨æŸ¥è¯¢"></a>ä½¿ç”¨JOINè¿›è¡Œå¤šè¡¨æŸ¥è¯¢</h2><p>åœ¨ MySQL ä¸­ï¼Œæœ€å¸¸ç”¨çš„å¤šè¡¨æŸ¥è¯¢æ–¹å¼æ˜¯ <strong><code>JOIN</code></strong>ã€‚</p>
<table>
<thead>
<tr>
<th align="left">æŸ¥è¯¢ç±»å‹</th>
<th align="left">åå­—</th>
<th align="left">æ•ˆæœ</th>
<th align="left">ä¸šåŠ¡åœºæ™¯</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>INNER JOIN</strong></td>
<td align="left"><strong>å†…è¿æ¥</strong></td>
<td align="left">åªæ˜¾ç¤º<strong>ä¸¤è¾¹éƒ½èƒ½å¯¹ä¸Š</strong>çš„æ•°æ®</td>
<td align="left">æŸ¥å‡ºé‚£äº›â€œç¡®å®ä¸‹è¿‡å•â€çš„ç”¨æˆ·å’Œè®¢å•</td>
</tr>
<tr>
<td align="left"><strong>LEFT JOIN</strong></td>
<td align="left"><strong>å·¦è¿æ¥</strong></td>
<td align="left"><strong>å·¦è¡¨å…¨ä¿ç•™</strong>ï¼Œå³è¡¨æ²¡å¯¹ä¸Šçš„æ˜¾ç¤º NULL</td>
<td align="left">æŸ¥å‡ºâ€œæ‰€æœ‰ç”¨æˆ·â€ï¼ŒåŒ…æ‹¬é‚£äº›è¿˜æ²¡ä¹°è¿‡ä¸œè¥¿çš„</td>
</tr>
<tr>
<td align="left"><strong>RIGHT JOIN</strong></td>
<td align="left"><strong>å³è¿æ¥</strong></td>
<td align="left"><strong>å³è¡¨å…¨ä¿ç•™</strong>ï¼ˆå¾ˆå°‘ç”¨ï¼Œé€šå¸¸ç”¨ LEFT JOIN ä»£æ›¿ï¼‰</td>
<td align="left">-</td>
</tr>
</tbody></table>
<h3 id="ä½¿ç”¨å†…è¿æ¥"><a href="#ä½¿ç”¨å†…è¿æ¥" class="headerlink" title="ä½¿ç”¨å†…è¿æ¥"></a>ä½¿ç”¨å†…è¿æ¥</h3><p>æ¯”å¦‚æˆ‘è¦æ‰¾åˆ°æ¯ä¸ªè®¢å•çš„ä¹°å®¶å’Œä¹°å®¶çš„æ‰‹æœºå·</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> users.username,users.phone,orders.order_no,orders.total_amount <span class="keyword">from</span> users <span class="keyword">inner</span> <span class="keyword">join</span> orders <span class="keyword">on</span> users.id <span class="operator">=</span> orders.user_id <span class="keyword">order</span> <span class="keyword">by</span> users.username;</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå¯ä»¥ä½¿ç”¨<code>AS</code>æ¥æ–¹ä¾¿å†™sqlè¯­å¥ï¼Œä¸¤è€…æ‰§è¡Œç»“æœæ˜¯ä¸€æ ·çš„ã€‚æˆ‘åŠ äº†ORDER BYæ¥ç”¨åå­—æ’åº</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    u.username, </span><br><span class="line">    u.phone, </span><br><span class="line">    o.order_no, </span><br><span class="line">    o.total_amount</span><br><span class="line"><span class="keyword">FROM</span> users <span class="keyword">AS</span> u </span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> orders <span class="keyword">AS</span> o <span class="keyword">ON</span> u.id <span class="operator">=</span> o.user_id</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> u.username; </span><br></pre></td></tr></table></figure>

<p>è¿™æ ·å°±ä¼šè¾“å‡º</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">+----------+-------------+------------------+--------------+</span><br><span class="line">| username | phone       | order_no         | total_amount |</span><br><span class="line">+----------+-------------+------------------+--------------+</span><br><span class="line">| ä¸å®     | 13473076571 | ORD2025092300097 |     13104.00 |</span><br><span class="line">| ä¸å®     | 13473076571 | ORD2025040100039 |      8057.00 |</span><br><span class="line">| ä¸å®     | 13473076571 | ORD2025040800086 |       129.00 |</span><br><span class="line">| ä½•å®     | 14796476245 | ORD2025030500020 |     13788.00 |</span><br><span class="line"></span><br><span class="line">....çœç•¥è‹¥å¹²</span><br></pre></td></tr></table></figure>

<h3 id="ä½¿ç”¨å·¦è¿æ¥"><a href="#ä½¿ç”¨å·¦è¿æ¥" class="headerlink" title="ä½¿ç”¨å·¦è¿æ¥"></a>ä½¿ç”¨å·¦è¿æ¥</h3><p>æ¯”å¦‚æˆ‘è¦æä¸€ä¸ªå¯Œè±ªæ¦œï¼ŒæŒ‰ç…§æ¶ˆè´¹é¢åº¦å¤§å°æä¸€ä¸ª<strong>ä¸æ¼æ‰æ²¡æœ‰ä¸‹è¿‡å•</strong>çš„äººçš„å…¨æ’åã€‚</p>
<p>ä½¿ç”¨ä¸‹é¢çš„sqlè¯­å¥</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    u.username, </span><br><span class="line">    <span class="built_in">SUM</span>(o.total_amount) <span class="keyword">as</span> money</span><br><span class="line"><span class="keyword">FROM</span> users <span class="keyword">AS</span> u</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> orders <span class="keyword">AS</span> o <span class="keyword">ON</span> u.id <span class="operator">=</span> o.user_id</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> money <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·æ‰§è¡Œå°±ä¼šæŠ¥é”™</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR: 1140 (42000): In aggregated query without GROUP BY, expression #1 of SELECT list contains nonaggregated column &#x27;mall_db_simple.u.username&#x27;; this is incompatible with sql_mode=only_full_group_by</span><br></pre></td></tr></table></figure>

<p>æŠ¥é”™ä¿¡æ¯é‡Œçš„ <code>only_full_group_by</code> å°±æ˜¯ï¼šâ€œæ—¢ç„¶ä½ ç”¨äº†èšåˆå‡½æ•°ï¼Œé‚£ä½ å¿…é¡»å‘Šè¯‰æˆ‘ï¼Œé‚£äº›æ²¡è¢«èšåˆçš„å­—æ®µè¯¥æŒ‰ä»€ä¹ˆè§„åˆ™æ’åˆ—ï¼Ÿâ€</p>
<p><strong><code>u.username</code></strong>ï¼šè¿™ä¸ªå­—æ®µï¼Œå®ƒæƒ³æŠŠè¡¨é‡Œæ‰€æœ‰çš„ç”¨æˆ·åéƒ½åˆ—å‡ºæ¥ï¼ˆå‡è®¾æœ‰ 100 è¡Œï¼‰ã€‚</p>
<p><strong><code>SUM(o.total_amount)</code></strong>ï¼šè¿™æ˜¯ä¸€ä¸ªèšåˆå‡½æ•°ï¼Œå®ƒçš„ç›®çš„æ˜¯æŠŠæ‰€æœ‰çš„é’±åŠ èµ·æ¥ï¼Œåªåå‡ºä¸€ä¸ªå€¼ï¼ˆ1 è¡Œï¼‰ã€‚</p>
<p>è®©æ•°æ®åº“åœ¨ç¬¬ä¸€åˆ—æ˜¾ç¤º 100 ä¸ªåå­—ï¼Œä½†åœ¨ç¬¬äºŒåˆ—åªæ˜¾ç¤º 1 ä¸ªæ€»é‡‘é¢ã€‚</p>
<p>é‚£è¿™ 1 ä¸ªæ€»é‡‘é¢ï¼Œåˆ°åº•æ˜¯å¯¹é½ç¬¬ä¸€ä¸ªäººï¼Ÿè¿˜æ˜¯æœ€åä¸€ä¸ªäººï¼Ÿè¿˜æ˜¯å¹³å‡åˆ†ç»™æ‰€æœ‰äººï¼Ÿæ•°æ®åº“æ²¡æ³•å¯¹é½</p>
<p>ä½¿ç”¨ GROUP BY æ¥æŒ‰äººåˆ†ç»„ï¼Œç®—å‡ºæ¯ä¸ªäººçš„é‡‘é¢</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    u.username, </span><br><span class="line">    <span class="built_in">SUM</span>(o.total_amount) <span class="keyword">as</span> money</span><br><span class="line"><span class="keyword">FROM</span> users <span class="keyword">AS</span> u</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> orders <span class="keyword">AS</span> o <span class="keyword">ON</span> u.id <span class="operator">=</span> o.user_id</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> u.username</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> money <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·å°±èƒ½æ­£å¸¸è¾“å‡º</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">+----------+----------+</span><br><span class="line">| username | money    |</span><br><span class="line">+----------+----------+</span><br><span class="line">| èƒ¡ç‰     | 22626.00 |</span><br><span class="line">| å‘¨é¾™     | 21825.00 |</span><br><span class="line">| ä¸å®     | 21290.00 |</span><br><span class="line">...çœç•¥è‹¥å¹²è¡Œ...</span><br><span class="line">| å‰æ¡‚èŠ   |     NULL |</span><br><span class="line">| è‰¾é™     |     NULL |</span><br><span class="line">| ç¨‹å¸…     |     NULL |</span><br><span class="line">+----------+----------+</span><br><span class="line">193 rows in set (0.0031 sec)</span><br></pre></td></tr></table></figure>

<p>æ²¡ä¸‹è¿‡å•çš„moneyåˆ—å°±ä¼šæ˜¯<code>NULL</code>ï¼Œæˆ‘æƒ³æŠŠå®ƒæ”¹æˆ0ï¼Œä½¿ç”¨<code>IFNULL</code>å‡½æ•°</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    u.username, </span><br><span class="line">    IFNULL(<span class="built_in">SUM</span>(o.total_amount),<span class="number">0</span>) <span class="keyword">as</span> money</span><br><span class="line"><span class="keyword">FROM</span> users <span class="keyword">AS</span> u</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> orders <span class="keyword">AS</span> o <span class="keyword">ON</span> u.id <span class="operator">=</span> o.user_id</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> u.username</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> money <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·çœ‹ç€å°±èˆ’æœå¤šäº†</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">+----------+----------+</span><br><span class="line">| username | money    |</span><br><span class="line">+----------+----------+</span><br><span class="line">| èƒ¡ç‰     | 22626.00 |</span><br><span class="line">| å‘¨é¾™     | 21825.00 |</span><br><span class="line">| ä¸å®     | 21290.00 |</span><br><span class="line">...çœç•¥è‹¥å¹²è¡Œ...</span><br><span class="line">| å‰æ¡‚èŠ   |     0.00 |</span><br><span class="line">| è‰¾é™     |     0.00 |</span><br><span class="line">| ç¨‹å¸…     |     0.00 |</span><br><span class="line">+----------+----------+</span><br><span class="line">193 rows in set (0.0023 sec)</span><br></pre></td></tr></table></figure>

<h2 id="ä½¿ç”¨å­æŸ¥è¯¢è¿›è¡Œå¤šè¡¨æŸ¥è¯¢"><a href="#ä½¿ç”¨å­æŸ¥è¯¢è¿›è¡Œå¤šè¡¨æŸ¥è¯¢" class="headerlink" title="ä½¿ç”¨å­æŸ¥è¯¢è¿›è¡Œå¤šè¡¨æŸ¥è¯¢"></a>ä½¿ç”¨å­æŸ¥è¯¢è¿›è¡Œå¤šè¡¨æŸ¥è¯¢</h2><p>å…ˆæŸ¥å‡ºä¸€ä¸ªç»“æœï¼Œå†æŠŠè¿™ä¸ªç»“æœä½œä¸ºæ¡ä»¶ä¼ ç»™ä¸‹ä¸€ä¸ªæŸ¥è¯¢</p>
<p>æ¯”å¦‚æˆ‘æƒ³æ‰¾å‡ºé‚£ä¸ªå•ç¬”è®¢å•èŠ±äº†æœ€å¤šé’±çš„ç”¨æˆ·ï¼Œå°±æ˜¯åˆ†æˆä¸¤ä¸ªæŸ¥è¯¢</p>
<p>1.ordersè¡¨é‡Œæ‰¾åˆ°å•ç¬”é‡‘é¢æœ€å¤§çš„userid</p>
<p>2.æ ¹æ®æ‰¾åˆ°çš„useridåœ¨usersè¡¨é‡Œæ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> id <span class="operator">=</span> (<span class="keyword">SELECT</span> user_id <span class="keyword">FROM</span> orders <span class="keyword">ORDER</span> <span class="keyword">BY</span> total_amount <span class="keyword">DESC</span> LIMIT <span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·å°±èƒ½è¾“å‡º</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+-----+----------+-----------------+-------------+--------+---------------------+</span><br><span class="line">| id  | username | email           | phone       | city   | created_at          |</span><br><span class="line">+-----+----------+-----------------+-------------+--------+---------------------+</span><br><span class="line">| 100 | å‘¨é¾™     | vyu@example.net | 18958822331 | é˜œæ–°å¿ | 2001-07-10 10:29:42 |</span><br><span class="line">+-----+----------+-----------------+-------------+--------+---------------------+</span><br><span class="line">1 row in set (0.0005 sec)</span><br></pre></td></tr></table></figure>

<p>å¦‚æœè¦æŠŠä¸Šé¢çš„å¯Œè±ªæ¦œæ”¹æˆå­æŸ¥è¯¢</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    u.username, </span><br><span class="line">    (<span class="keyword">SELECT</span> IFNULL(<span class="built_in">SUM</span>(orders.total_amount), <span class="number">0</span>) </span><br><span class="line">     <span class="keyword">FROM</span> orders</span><br><span class="line">     <span class="keyword">WHERE</span> orders.user_id <span class="operator">=</span> u.id) <span class="keyword">AS</span> money</span><br><span class="line"><span class="keyword">FROM</span> users <span class="keyword">AS</span> u  </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> money <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<p>æ•ˆæœæ˜¯ä¸€æ ·çš„</p>
<h1 id="ç´¢å¼•"><a href="#ç´¢å¼•" class="headerlink" title="ç´¢å¼•"></a>ç´¢å¼•</h1><p>å¦‚æœæŠŠæ•°æ®åº“æ¯”ä½œä¸€æœ¬ã€Šæ–°åå­—å…¸ã€‹ï¼Œé‚£â€œç´¢å¼•â€å°±æ˜¯å­—å…¸å‰é¢çš„æ‹¼éŸ³æ£€ç´¢è¡¨ã€‚</p>
<ul>
<li><strong>æ²¡ç´¢å¼•ï¼ˆå…¨è¡¨æ‰«æ &#x2F; Full Table Scanï¼‰</strong>ï¼š<br>å‡è®¾è¦æŸ¥â€œå­—â€è¿™ä¸ªå­—ï¼Œä½†å­—å…¸æ²¡æœ‰ç›®å½•ã€‚ä½ åªèƒ½ä»ç¬¬ä¸€é¡µå¼€å§‹ï¼Œä¸€é¡µä¸€é¡µå¾€åç¿»ï¼Œç›´åˆ°ç¿»åˆ°ä¸ºæ­¢ã€‚å¦‚æœå­—å…¸æœ‰ 1000 é¡µï¼Œæœ€åæƒ…å†µä½ è¦ç¿» 1000 æ¬¡ã€‚<ul>
<li><em>æ•ˆç‡</em>ï¼šæä½ O(n)ã€‚</li>
</ul>
</li>
<li><strong>æœ‰ç´¢å¼•ï¼ˆIndexï¼‰</strong>ï¼š<br>å…ˆçœ‹å‰é¢çš„æ‹¼éŸ³ç›®å½•ï¼Œæ‰¾åˆ° <code>zi</code> åœ¨ç¬¬ 500 é¡µã€‚ç›´æ¥ç¿»åˆ°ç¬¬ 500 é¡µã€‚<ul>
<li><em>æ•ˆç‡</em>ï¼šæé«˜ O(log n)ï¼ˆå› ä¸º MySQL åº•å±‚ç”¨çš„æ˜¯ <strong>B+æ ‘</strong> ç»“æ„ï¼Œç±»ä¼¼äºŒåˆ†æŸ¥æ‰¾ï¼‰ã€‚<br><strong>æ ¸å¿ƒä½œç”¨</strong>ï¼š<strong>ä»¥ç©ºé—´æ¢æ—¶é—´</strong>ã€‚ç´¢å¼•æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æ–‡ä»¶ï¼Œå ç”¨ç¡¬ç›˜ç©ºé—´ï¼Œä½†èƒ½è®©æŸ¥è¯¢é€Ÿåº¦æå‡ç™¾å€åƒå€ã€‚</li>
</ul>
</li>
</ul>
<p>å…¶å®é‚£ä¸ªpythonåœ¨åˆ›å»ºæ•°æ®è¡¨çš„æ—¶å€™ï¼Œæ¯ä¸ªè¡¨åˆ›å»ºäº†ä¸€ä¸ªä¸»é”®ã€‚</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  localhost:<span class="number">3306</span>  mall_db_simple  <span class="keyword">SQL</span> <span class="operator">&gt;</span> <span class="keyword">show</span> index <span class="keyword">from</span> users;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Table</span> <span class="operator">|</span> Non_unique <span class="operator">|</span> Key_name <span class="operator">|</span> Seq_in_index <span class="operator">|</span> Column_name <span class="operator">|</span> <span class="keyword">Collation</span> <span class="operator">|</span> <span class="keyword">Cardinality</span> <span class="operator">|</span> Sub_part <span class="operator">|</span> Packed <span class="operator">|</span> <span class="keyword">Null</span> <span class="operator">|</span> Index_type <span class="operator">|</span> Comment <span class="operator">|</span> Index_comment <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span></span><br><span class="line"><span class="operator">|</span> users <span class="operator">|</span>          <span class="number">0</span> <span class="operator">|</span> <span class="keyword">PRIMARY</span>  <span class="operator">|</span>            <span class="number">1</span> <span class="operator">|</span> id          <span class="operator">|</span> A         <span class="operator">|</span>     <span class="number">2000000</span> <span class="operator">|</span>     <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>   <span class="operator">|</span>      <span class="operator">|</span> BTREE      <span class="operator">|</span>         <span class="operator">|</span>               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.0011</span> sec)</span><br></pre></td></tr></table></figure>

<p>è€Œä¸»é”®æ˜¯è¢«Mysqlé»˜è®¤ä½œä¸ºä¸€ä¸ªç´¢å¼•</p>
<h2 id="ä¸»é”®ç´¢å¼•æœ‰ä»€ä¹ˆç”¨ï¼Ÿ"><a href="#ä¸»é”®ç´¢å¼•æœ‰ä»€ä¹ˆç”¨ï¼Ÿ" class="headerlink" title="ä¸»é”®ç´¢å¼•æœ‰ä»€ä¹ˆç”¨ï¼Ÿ"></a>ä¸»é”®ç´¢å¼•æœ‰ä»€ä¹ˆç”¨ï¼Ÿ</h2><h3 id="å®šä½ä¸€è¡Œæ•°æ®"><a href="#å®šä½ä¸€è¡Œæ•°æ®" class="headerlink" title="å®šä½ä¸€è¡Œæ•°æ®"></a>å®šä½ä¸€è¡Œæ•°æ®</h3><p>æ¯”å¦‚è¿™æ ·çš„ä¸€æ¡sql</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">10086</span>;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸æ˜¯â€œæŸ¥æ¡ä»¶â€ï¼Œæ˜¯â€œ<strong>æˆ‘çŸ¥é“ä½ æ˜¯è°ï¼Œç›´æ¥æŠŠä½ æ‹å‡ºæ¥</strong>â€ã€‚</p>
<p>ä¸æ‰«è¡¨ï¼Œä¸æ¯”å¯¹ï¼Œç›´æ¥åœ¨ B+Tree ä¸Šç²¾å‡†å®šä½</p>
<p>å¤æ‚åº¦æ˜¯ <code>O(log n)</code>ï¼Œè€Œä¸æ˜¯ <code>O(n)</code>ã€‚</p>
<h3 id="å†³å®šæ•°æ®åœ¨ç£ç›˜ä¸Šçš„ç‰©ç†é¡ºåº"><a href="#å†³å®šæ•°æ®åœ¨ç£ç›˜ä¸Šçš„ç‰©ç†é¡ºåº" class="headerlink" title="å†³å®šæ•°æ®åœ¨ç£ç›˜ä¸Šçš„ç‰©ç†é¡ºåº"></a>å†³å®šæ•°æ®åœ¨ç£ç›˜ä¸Šçš„ç‰©ç†é¡ºåº</h3><p>åœ¨ InnoDB é‡Œï¼Œè¡¨ä¸­çš„æ¯ä¸€è¡Œï¼Œæ˜¯æŒ‰ä¸»é”®é¡ºåºæ’åœ¨ä¸€èµ·å­˜çš„</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id <span class="type">INT</span> AUTO_INCREMENT <span class="keyword">PRIMARY KEY</span></span><br></pre></td></tr></table></figure>

<p>æ„å‘³ç€ï¼Œid å°çš„åœ¨å‰ï¼Œid å¤§çš„åœ¨åï¼Œæ•°æ®é¡µé¡ºç€æ’</p>
<p>å¦‚æœè¦æ‰§è¡Œè¿™æ ·çš„æŸ¥è¯¢</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> id <span class="keyword">BETWEEN</span> <span class="number">100</span> <span class="keyword">AND</span> <span class="number">200</span>;</span><br></pre></td></tr></table></figure>

<p>æ•°æ®å°±åœ¨ç£ç›˜ä¸Šè¿ç€ï¼Œä¸€é¡µä¸€é¡µé¡ºç€å°±è¯»ä¸‹å»äº†</p>
<p>å¹¶ä¸”è¿™æ ·joinçš„ä¹Ÿå¿«ï¼Œåªè¦ join çš„æ˜¯ä¸»é”®</p>
<h3 id="æ™®é€šç´¢å¼•çš„â€œæœ€ç»ˆè½è„šç‚¹â€"><a href="#æ™®é€šç´¢å¼•çš„â€œæœ€ç»ˆè½è„šç‚¹â€" class="headerlink" title="æ™®é€šç´¢å¼•çš„â€œæœ€ç»ˆè½è„šç‚¹â€"></a>æ™®é€šç´¢å¼•çš„â€œæœ€ç»ˆè½è„šç‚¹â€</h3><p>åœ¨ InnoDB é‡Œï¼šæ™®é€šç´¢å¼• â‰  æŒ‡å‘è¡Œæ•°æ®ï¼Œè€Œæ˜¯æ™®é€šç´¢å¼• â†’ æŒ‡å‘ä¸»é”®</p>
<p>æ™®é€šç´¢å¼•èŠ‚ç‚¹é‡Œå­˜çš„æ˜¯ï¼šç´¢å¼•å€¼ + ä¸»é”®å€¼</p>
<h2 id="å›è¡¨ï¼Ÿ"><a href="#å›è¡¨ï¼Ÿ" class="headerlink" title="å›è¡¨ï¼Ÿ"></a>å›è¡¨ï¼Ÿ</h2><h3 id="ä»€ä¹ˆæ˜¯å›è¡¨"><a href="#ä»€ä¹ˆæ˜¯å›è¡¨" class="headerlink" title="ä»€ä¹ˆæ˜¯å›è¡¨"></a>ä»€ä¹ˆæ˜¯å›è¡¨</h3><p>æ¯”å¦‚æœ‰è¿™ä¹ˆä¸€å¼ è¡¨</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">users(</span><br><span class="line">  id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">  username <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">  email <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">  balance <span class="type">DECIMAL</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">INDEX idx_email(email)</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œè¿™æ ·çš„æŸ¥è¯¢</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> email <span class="operator">=</span> <span class="string">&#x27;a@b.com&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>å®é™…åœ¨Mysqlé‡Œæ˜¯è¿™æ ·çš„ï¼š</p>
<p>å…ˆåœ¨<code>idx_email</code>é‡Œï¼Œæ ¹æ®<code> a@b.com</code> æ‰¾åˆ° <code>id=100</code><br>è¿™é‡Œåªæœ‰<code>email</code>å’Œ<code>id</code>ï¼Œæ²¡æœ‰<code>balance</code>å’Œ<code>username</code></p>
<p>ç„¶åå†ç”¨<code>id</code>æ‰¾åˆ°è¿™ä¸€è¡Œçš„æ•°æ®ï¼Œè¿™ä¸€æ­¥å°±æ˜¯å›è¡¨</p>
<p>ä»æ™®é€šç´¢å¼• â†’ å›åˆ°ä¸»é”®ç´¢å¼• â†’ æ‹¿æ•´è¡Œæ•°æ®</p>
<h3 id="ä»€ä¹ˆæ—¶å€™ä¼šå‘ç”Ÿå›è¡¨"><a href="#ä»€ä¹ˆæ—¶å€™ä¼šå‘ç”Ÿå›è¡¨" class="headerlink" title="ä»€ä¹ˆæ—¶å€™ä¼šå‘ç”Ÿå›è¡¨"></a>ä»€ä¹ˆæ—¶å€™ä¼šå‘ç”Ÿå›è¡¨</h3><p>åƒè¿™æ ·</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> email <span class="operator">=</span> <span class="string">&#x27;a@b.com&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>ç”¨äº†æ™®é€šç´¢å¼•ï¼Œä½†æ˜¯è¦åˆ—é‡Œæ‰€æœ‰æ•°æ®ï¼Œç´¢å¼•é‡Œæ²¡æœ‰è¿™ä¹ˆå¤šåˆ—å°±ä¼šå›è¡¨</p>
<p>ä½†æ˜¯å¦‚æœæ˜¯è¿™æ ·</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> email <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> email <span class="operator">=</span> <span class="string">&#x27;a@b.com&#x27;</span>;</span><br><span class="line">æˆ–è€…</span><br><span class="line"><span class="keyword">SELECT</span> email, id <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> email <span class="operator">=</span> <span class="string">&#x27;a@b.com&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·å°±ä¸ä¼šå›è¡¨ï¼Œå› ä¸ºè¦æ‰¾çš„ä¸œè¥¿åœ¨ç´¢å¼•é‡Œå°±æœ‰äº†</p>
<h2 id="ç´¢å¼•çš„ä½¿ç”¨"><a href="#ç´¢å¼•çš„ä½¿ç”¨" class="headerlink" title="ç´¢å¼•çš„ä½¿ç”¨"></a>ç´¢å¼•çš„ä½¿ç”¨</h2><p>è¿˜æ˜¯é‚£ä¸ªpyï¼ŒæŠŠç”¨æˆ·æ”¹æˆä¸¤ç™¾ä¸‡ä¸ªï¼Œè¿è¡ŒPyåæ‰§è¡Œä¸‹é¢çš„æŸ¥è¯¢</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> username <span class="keyword">LIKE</span> &quot;å“ˆåŸº&quot;;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œåæ˜¯æ‰¾ä¸åˆ°è¿™ä¸ªæ•°æ®çš„ï¼Œè¿™ä¸ªæ­£å¸¸ï¼Œä¸»è¦çœ‹æ‰¾æ•°æ®èŠ±äº†å¤šä¹…ï¼Ÿ</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MySQL  localhost:3306  mall_db_simple  SQL &gt; SELECT * FROM users WHERE username LIKE &quot;å“ˆåŸº&quot;;</span><br><span class="line">Empty set (0.2233 sec)</span><br></pre></td></tr></table></figure>

<p>0.22ç§’ï¼Œçœ‹èµ·æ¥ä¸å¤šï¼Œçº¯ç²¹æ˜¯å› ä¸ºæˆ‘çš„ç”µè„‘ç¡¬ä»¶ï¼ˆCPUã€å†…å­˜ã€SSDï¼‰å¤ªå¼ºäº†ï¼ŒæŠŠâ€œç¬¨é‡â€çš„ SQL ç¡¬æ‰›ä¸‹æ¥äº†ã€‚å¦‚æœæ˜¯è¦é¢å¯¹å¤§é‡å¹¶å‘æŸ¥è¯¢ï¼Œæ¯æ¬¡å…¨è¡¨æ‰«æå°±å¤ªæ…¢äº†</p>
<p><code>users</code> è¡¨é‡Œç°åœ¨åªæœ‰ä¸»é”®ç´¢å¼•ï¼ˆPRIMARYï¼‰ï¼Œä½†æŸ¥è¯¢æ¡ä»¶æ˜¯ <code>WHERE username LIKE ...</code>ã€‚å› ä¸º <code>username</code> æ²¡æœ‰ç´¢å¼•ï¼Œ<strong>MySQL å…¶å®åšäº†ä¸€æ¬¡â€œå…¨è¡¨æ‰«æâ€</strong>ã€‚</p>
<p>æ‰§è¡Œä¸‹é¢çš„SQLçœ‹çœ‹æ˜¯æ€ä¹ˆæŸ¥è¯¢çš„</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> username <span class="keyword">LIKE</span> &quot;å“ˆåŸº&quot;;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œè¾“å‡º:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+-------------+</span><br><span class="line">| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows    | filtered | Extra       |</span><br><span class="line">+----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+-------------+</span><br><span class="line">|  1 | SIMPLE      | users | NULL       | ALL  | NULL          | NULL | NULL    | NULL | 2000000 |    11.11 | Using where |</span><br><span class="line">+----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+-------------+</span><br><span class="line">1 row in set, 1 warning (0.0010 sec)</span><br><span class="line">Note (code 1003): /* select#1 */ select `mall_db_simple`.`users`.`id` AS `id`,`mall_db_simple`.`users`.`username` AS `username`,`mall_db_simple`.`users`.`email` AS `email`,`mall_db_simple`.`users`.`phone` AS `phone`,`mall_db_simple`.`users`.`city` AS `city`,`mall_db_simple`.`users`.`created_at` AS `created_at` from `mall_db_simple`.`users` where (`mall_db_simple`.`users`.`username` like &#x27;å“ˆåŸº&#x27;)</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°typeåˆ—æ˜¯<code>ALL</code>(ä»£è¡¨å…¨è¡¨æ‰«æï¼Œæœ€çƒ‚çš„æƒ…å†µ) ï¼Œrowsåˆ—æ˜¯<code>2000000</code>éå†äº†ä¸¤ç™¾ä¸‡è¡Œ</p>
<h3 id="åˆ›å»ºå’Œä½¿ç”¨ç´¢å¼•"><a href="#åˆ›å»ºå’Œä½¿ç”¨ç´¢å¼•" class="headerlink" title="åˆ›å»ºå’Œä½¿ç”¨ç´¢å¼•"></a>åˆ›å»ºå’Œä½¿ç”¨ç´¢å¼•</h3><p>åˆ›å»ºç´¢å¼•çš„SQLè¯­å¥æ˜¯</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> INDEX ç´¢å¼•å <span class="keyword">ON</span> è¡¨å(å­—æ®µå);</span><br></pre></td></tr></table></figure>

<p>åœ¨è¿™é‡Œå°±æ˜¯</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> INDEX idx_username <span class="keyword">ON</span> users(username);</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œåå†æ¬¡è¿è¡Œä¸Šé¢é‚£ä¸ªæŸ¥è¯¢ï¼Œå¯ä»¥çœ‹åˆ°æ˜¯ç¬é—´ç»™å‡ºç»“æœäº†</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MySQL  localhost:3306  mall_db_simple  SQL &gt; SELECT * FROM users WHERE username LIKE &quot;å“ˆåŸº&quot;;</span><br><span class="line">Empty set (0.0004 sec)</span><br></pre></td></tr></table></figure>

<p>åªç”¨äº†0.0004ç§’ï¼Œç°åœ¨å†çœ‹çœ‹Mysqlæ˜¯æ€ä¹ˆæŸ¥è¯¢çš„</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MySQL  localhost:3306  mall_db_simple  SQL &gt; EXPLAIN SELECT * FROM users WHERE username LIKE &quot;å“ˆåŸº&quot;;</span><br><span class="line">+----+-------------+-------+------------+-------+---------------+--------------+---------+------+------+----------+-----------------------+</span><br><span class="line">| id | select_type | table | partitions | type  | possible_keys | key          | key_len | ref  | rows | filtered | Extra                 |</span><br><span class="line">+----+-------------+-------+------------+-------+---------------+--------------+---------+------+------+----------+-----------------------+</span><br><span class="line">|  1 | SIMPLE      | users | NULL       | range | idx_username  | idx_username | 203     | NULL |    1 |      100 | Using index condition |</span><br><span class="line">+----+-------------+-------+------------+-------+---------------+--------------+---------+------+------+----------+-----------------------+</span><br><span class="line">1 row in set, 1 warning (0.0004 sec)</span><br><span class="line">Note (code 1003): /* select#1 */ select `mall_db_simple`.`users`.`id` AS `id`,`mall_db_simple`.`users`.`username` AS `username`,`mall_db_simple`.`users`.`email` AS `email`,`mall_db_simple`.`users`.`phone` AS `phone`,`mall_db_simple`.`users`.`city` AS `city`,`mall_db_simple`.`users`.`created_at` AS `created_at` from `mall_db_simple`.`users` where (`mall_db_simple`.`users`.`username` like &#x27;å“ˆåŸº&#x27;)</span><br></pre></td></tr></table></figure>

<p>çœ‹rowsåˆ—å˜æˆäº†1ï¼Œå°±æ˜¯è¯´æ˜åªéœ€è¦æ‰« <strong>1 æ¡ç´¢å¼•è®°å½•</strong>ï¼Œå°±èƒ½å‘½ä¸­</p>
<h3 id="åˆ é™¤ç´¢å¼•"><a href="#åˆ é™¤ç´¢å¼•" class="headerlink" title="åˆ é™¤ç´¢å¼•"></a>åˆ é™¤ç´¢å¼•</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> INDEX ç´¢å¼•å <span class="keyword">ON</span> è¡¨å;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœç´¢å¼•å»ºé”™äº†ï¼Œæˆ–è€…æ²¡ç”¨ä¸Šï¼Œè¦åˆ æ‰ï¼ˆå› ä¸ºç´¢å¼•ä¼šæ‹–æ…¢å†™å…¥é€Ÿåº¦ï¼‰ã€‚å°±ç”¨ä¸Šé¢çš„å‘½ä»¤ã€‚æˆ‘ä¸æ¼”ç¤ºäº†</p>
<h2 id="ç´¢å¼•çš„å‰¯ä½œç”¨"><a href="#ç´¢å¼•çš„å‰¯ä½œç”¨" class="headerlink" title="ç´¢å¼•çš„å‰¯ä½œç”¨"></a>ç´¢å¼•çš„å‰¯ä½œç”¨</h2><p>æ—¢ç„¶è¿™ä¹ˆå¥½ï¼Œä¸ºå•¥ä¸ç»™æ‰€æœ‰å­—æ®µéƒ½åŠ ï¼Ÿç»™ <code>username</code>, <code>phone</code>, <code>email</code>, <code>address</code> å…¨åŠ ä¸Šç´¢å¼•ï¼Œå²‚ä¸æ˜¯èµ·é£ï¼Ÿ</p>
<ol>
<li><strong>æ‹–æ…¢å†™å…¥ï¼ˆINSERT&#x2F;UPDATE&#x2F;DELETEï¼‰</strong>ï¼š<ul>
<li>å¾€ä¹¦é‡Œ<strong>å†™</strong>ä¸€è¡Œå†…å®¹ï¼ˆINSERTï¼‰ï¼Œä¸ä»…è¦å¾€æ­£æ–‡é‡Œå†™ï¼Œè¿˜å¾—å»<strong>æ”¹ç›®å½•</strong>ï¼ˆç»´æŠ¤ç´¢å¼•æ ‘ï¼‰ã€‚ç´¢å¼•è¶Šå¤šï¼Œæ”¹ç›®å½•è¶Šæ…¢ã€‚</li>
<li>å¯¹äºå†™å¤šè¯»å°‘çš„ç³»ç»Ÿï¼ˆæ¯”å¦‚æ—¥å¿—ç³»ç»Ÿï¼‰ï¼Œç´¢å¼•è¦æ…ç”¨ã€‚</li>
</ul>
</li>
<li><strong>å ç”¨ç£ç›˜ç©ºé—´</strong>ï¼š<ul>
<li>ç´¢å¼•ä¹Ÿæ˜¯æ–‡ä»¶ï¼Œä¹Ÿæ˜¯è¦å­˜ç¡¬ç›˜çš„ã€‚æ•°æ®é‡å¤§æ—¶ï¼Œç´¢å¼•å¯èƒ½æ¯”æ•°æ®æœ¬èº«è¿˜å¤§ã€‚</li>
</ul>
</li>
</ol>
<h2 id="LIKEçš„å‘"><a href="#LIKEçš„å‘" class="headerlink" title="LIKEçš„å‘"></a>LIKEçš„å‘</h2><p>åœ¨åˆšåˆšçš„SQLé‡Œä½¿ç”¨äº†LIKEä½†æ˜¯æ²¡æœ‰åŠ ç™¾åˆ†å·ã€‚ä¹Ÿå°±æ˜¯è¯´å…¶å®è¿˜æ˜¯ä½¿ç”¨çš„ç²¾ç¡®åŒ¹é…</p>
<ol>
<li><p><strong>ç²¾ç¡®åŒ¹é…&#x2F;å‰ç¼€åŒ¹é…ï¼ˆç´¢å¼•ç”Ÿæ•ˆ ï¼‰</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> username <span class="keyword">LIKE</span> &quot;å“ˆåŸº%&quot;;</span><br></pre></td></tr></table></figure>

<p>ç»“æœï¼š<code>type</code> æ˜¯ <code>range</code> æˆ– <code>ref</code>ã€‚ç´¢å¼•ç”Ÿæ•ˆäº†ï¼å› ä¸ºç›®å½•æ˜¯æŒ‰æ‹¼éŸ³æ’çš„ï¼ŒMySQL çŸ¥é“â€œå“ˆâ€åœ¨å‰é¢çš„å‡ é¡µã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+----+-------------+-------+------------+-------+---------------+--------------+---------+------+------+----------+-----------------------+</span><br><span class="line">| id | select_type | table | partitions | type  | possible_keys | key          | key_len | ref  | rows | filtered | Extra                 |</span><br><span class="line">+----+-------------+-------+------------+-------+---------------+--------------+---------+------+------+----------+-----------------------+</span><br><span class="line">|  1 | SIMPLE      | users | NULL       | range | idx_username  | idx_username | 203     | NULL |    1 |      100 | Using index condition |</span><br><span class="line">+----+-------------+-------+------------+-------+---------------+--------------+---------+------+------+----------+-----------------------+</span><br><span class="line">1 row in set, 1 warning (0.0009 sec)</span><br><span class="line">Note (code 1003): /* select#1 */ select `mall_db_simple`.`users`.`id` AS `id`,`mall_db_simple`.`users`.`username` AS `username`,`mall_db_simple`.`users`.`email` AS `email`,`mall_db_simple`.`users`.`phone` AS `phone`,`mall_db_simple`.`users`.`city` AS `city`,`mall_db_simple`.`users`.`created_at` AS `created_at` from `mall_db_simple`.`users` where (`mall_db_simple`.`users`.`username` like &#x27;å“ˆåŸº%&#x27;)</span><br></pre></td></tr></table></figure></li>
<li><p><strong>å·¦æ¨¡ç³ŠåŒ¹é…ï¼ˆç´¢å¼•å¤±æ•ˆ ï¼‰</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- æ‰¾åå­—é‡Œä»¥â€œç±³â€ç»“å°¾çš„äººï¼ˆæ¯”å¦‚å“ˆåŸºç±³ã€å°ç±³ï¼‰</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> username <span class="keyword">LIKE</span> &quot;%ç±³&quot;;</span><br></pre></td></tr></table></figure>

<p>ç»“æœï¼š<code>type</code> åˆæ˜¯ <strong><code>ALL</code></strong> äº†ï¼</p>
<p>æŸ¥å­—å…¸çš„æ—¶å€™ï¼Œå¦‚æœåªçŸ¥é“è¿™å°±å­—â€œç»“å°¾æ˜¯ç±³â€ï¼Œæ²¡æ³•ç”¨æ‹¼éŸ³ç›®å½•æŸ¥ï¼Œåªèƒ½æŠŠæ•´æœ¬å­—å…¸ç¿»ä¸€éã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+-------------+</span><br><span class="line">| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows    | filtered | Extra       |</span><br><span class="line">+----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+-------------+</span><br><span class="line">|  1 | SIMPLE      | users | NULL       | ALL  | NULL          | NULL | NULL    | NULL | 2000000 |    11.11 | Using where |</span><br><span class="line">+----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+-------------+</span><br><span class="line">1 row in set, 1 warning (0.0003 sec)</span><br><span class="line">Note (code 1003): /* select#1 */ select `mall_db_simple`.`users`.`id` AS `id`,`mall_db_simple`.`users`.`username` AS `username`,`mall_db_simple`.`users`.`email` AS `email`,`mall_db_simple`.`users`.`phone` AS `phone`,`mall_db_simple`.`users`.`city` AS `city`,`mall_db_simple`.`users`.`created_at` AS `created_at` from `mall_db_simple`.`users` where (`mall_db_simple`.`users`.`username` like &#x27;%ç±³&#x27;)</span><br></pre></td></tr></table></figure></li>
</ol>
<p>å¦‚æœæˆ‘æƒ³å€’ç€æŸ¥ä¹Ÿèƒ½ç¬é—´ç»™å‡ºç»“æœï¼Ÿä½¿ç”¨<strong>è™šæ‹Ÿåˆ—</strong>åŠŸèƒ½</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 1. ç»™è¡¨åŠ ä¸€ä¸ªè™šæ‹Ÿåˆ—ï¼Œå†…å®¹æ˜¯ username çš„å€’åº</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> users <span class="keyword">ADD</span> reverse_username <span class="type">VARCHAR</span>(<span class="number">50</span>) </span><br><span class="line">GENERATED ALWAYS <span class="keyword">AS</span> (REVERSE(username));</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2. ç»™è¿™ä¸ªå€’åºåˆ—åŠ ç´¢å¼•</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_reverse_username <span class="keyword">ON</span> users(reverse_username);</span><br></pre></td></tr></table></figure>

<p>å¦‚æœä½¿ç”¨çš„æ˜¯Windowsçš„phpstudyä¸­çš„Mysql5.7ï¼Œé»˜è®¤ä¸ä¼šæ˜¯InnoDBï¼Œåœ¨æ‰§è¡Œç¬¬äºŒæ­¥å°±ä¼šæŠ¥é”™</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR: 1478 (HY000): Table storage engine &#x27;MyISAM&#x27; does not support the create option &#x27;Index on virtual generated column&#x27;</span><br></pre></td></tr></table></figure>

<p>è¿™æ—¶å€™ä½¿ç”¨ALTERå‘½ä»¤ä¿®æ”¹å­˜å‚¨å¼•æ“ä¸ºInnoDB</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER TABLE</span> users ENGINE<span class="operator">=</span>InnoDB;</span><br></pre></td></tr></table></figure>

<p>å†æ‰§è¡Œç¬¬äºŒæ­¥å°±æ­£å¸¸äº†ï¼Œç°åœ¨çœ‹çœ‹å·¦æ¨¡ç³ŠåŒ¹é…æ•ˆæœï¼Œä¸è¿‡å¾—åœ¨usernameçš„å€’åºåˆ—é‡ŒæŸ¥æ‰¾</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">MySQL  localhost:3306  mall_db_simple  SQL &gt; SELECT * FROM users WHERE reverse_username LIKE &quot;ç±³%&quot;;</span><br><span class="line">Empty set (0.0015 sec)</span><br><span class="line">MySQL  localhost:3306  mall_db_simple  SQL &gt; EXPLAIN SELECT * FROM users WHERE reverse_username LIKE &quot;ç±³%&quot;;</span><br><span class="line">+----+-------------+-------+------------+-------+----------------------+----------------------+---------+------+------+----------+-------------+</span><br><span class="line">| id | select_type | table | partitions | type  | possible_keys        | key                  | key_len | ref  | rows | filtered | Extra       |</span><br><span class="line">+----+-------------+-------+------------+-------+----------------------+----------------------+---------+------+------+----------+-------------+</span><br><span class="line">|  1 | SIMPLE      | users | NULL       | range | idx_reverse_username | idx_reverse_username | 203     | NULL |    1 |      100 | Using where |</span><br><span class="line">+----+-------------+-------+------------+-------+----------------------+----------------------+---------+------+------+----------+-------------+</span><br><span class="line">1 row in set, 1 warning (0.0008 sec)</span><br><span class="line">Note (code 1003): /* select#1 */ select `mall_db_simple`.`users`.`id` AS `id`,`mall_db_simple`.`users`.`username` AS `username`,`mall_db_simple`.`users`.`email` AS `email`,`mall_db_simple`.`users`.`phone` AS `phone`,`mall_db_simple`.`users`.`city` AS `city`,`mall_db_simple`.`users`.`created_at` AS `created_at`,`mall_db_simple`.`users`.`reverse_username` AS `reverse_username` from `mall_db_simple`.`users` where (`mall_db_simple`.`users`.`reverse_username` like &#x27;ç±³%&#x27;)</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿæ˜¯ç§’å‡ºã€‚ä¹Ÿåªç”¨æ‰«æä¸€æ¡è®°å½•</p>
<h1 id="äº‹åŠ¡"><a href="#äº‹åŠ¡" class="headerlink" title="äº‹åŠ¡"></a>äº‹åŠ¡</h1><p>äº‹åŠ¡æ˜¯ä¸æ”¯æŒMyISAMå­˜å‚¨å¼•æ“çš„</p>
<p>äº‹åŠ¡æ˜¯æŠŠä¸€ç»„SQLè¯­å¥æ‰“åŒ…æˆä¸€ä¸ªæ•´ä½“ï¼Œåœ¨è¿™ç»„SQLè¯­å¥çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚è¿™ç»„SQLè¯­å¥å¯ä»¥æ˜¯ä¸€æ¡ä¹Ÿå¯ä»¥æ˜¯å¤šæ¡ã€‚</p>
<h2 id="äº‹åŠ¡çš„å…«è‚¡"><a href="#äº‹åŠ¡çš„å…«è‚¡" class="headerlink" title="äº‹åŠ¡çš„å…«è‚¡:"></a>äº‹åŠ¡çš„å…«è‚¡:</h2><ul>
<li><strong>A (Atomicity) åŸå­æ€§</strong>ï¼š<ul>
<li>äº‹åŠ¡ä¸­çš„æ‰€æœ‰æ“ä½œå°±æ˜¯ä¸€ä¸ªä¸å¯åˆ†å‰²çš„æ•´ä½“ï¼ŒåƒåŸå­ä¸€æ ·ã€‚è¿™äº›æ“ä½œï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚æ•°æ®åº“ä¼šè®°å½•äº‹åŠ¡æ‰§è¡Œå‰çš„æ•°æ®çŠ¶æ€ï¼Œä¸€æ—¦äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹å‡ºç°å¤±è´¥ï¼Œå°±ä¼šå›æ»šåˆ°åŸæ¥çš„åˆå§‹çŠ¶æ€ã€‚</li>
<li><em>åŸç†</em>ï¼šé  <strong>Undo Log</strong> å®ç°ï¼ˆä¸‡ä¸€å¤±è´¥äº†ï¼Œæ ¹æ®æ—¥å¿—æŠŠæ•°æ®æ”¹å›å»ï¼‰ã€‚</li>
</ul>
</li>
<li><strong>C (Consistency) ä¸€è‡´æ€§</strong>ï¼š<ul>
<li>äº‹åŠ¡æ‰§è¡Œå‰åï¼Œäº‹åŠ¡çš„å®Œæ•´æ€§ä¸ä¼šè¢«ç ´åã€‚äº‹åŠ¡æ‰§è¡Œå®Œæˆä¹‹åï¼Œä¿è¯æ•°æ®æ­£ç¡®å¹¶ä¸”ç¬¦åˆé¢„æœŸã€‚</li>
</ul>
</li>
<li><strong>I (Isolation) éš”ç¦»æ€§</strong>ï¼š<ul>
<li>æ•°æ®åº“å…è®¸å¤šä¸ªå¹¶å‘äº‹åŠ¡åŒæ—¶å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹å’Œè¯»å†™ï¼Œéš”ç¦»æ€§å¯ä»¥ä¿è¯å¤šä¸ªäº‹åŠ¡å¹¶å‘æ‰§è¡Œï¼Œå¹¶ä¸”ä¸ç›¸äº’å¹²æ‰°ã€‚</li>
<li><em>åŸç†</em>ï¼šé  <strong>é” (Lock)</strong> å’Œ <strong>MVCC (å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶)</strong> å®ç°ã€‚</li>
</ul>
</li>
<li><strong>D (Durability) æŒä¹…æ€§</strong>ï¼š<ul>
<li>åªè¦ <code>COMMIT</code> äº†ï¼Œå“ªæ€•ä¸‹ä¸€ç§’æœåŠ¡å™¨çˆ†ç‚¸ï¼Œç”µçº¿è¢«æŒ–æ–­ï¼Œæ•°æ®ä¹Ÿä¸èƒ½ä¸¢ã€‚</li>
<li><em>åŸç†</em>ï¼šé  <strong>Redo Log</strong> å®ç°ï¼ˆå…ˆå†™æ—¥å¿—å†å†™ç£ç›˜ï¼‰ã€‚</li>
</ul>
</li>
</ul>
<h2 id="äº‹åŠ¡æŒ‡ä»¤"><a href="#äº‹åŠ¡æŒ‡ä»¤" class="headerlink" title="äº‹åŠ¡æŒ‡ä»¤"></a>äº‹åŠ¡æŒ‡ä»¤</h2><table>
<thead>
<tr>
<th align="left">æŒ‡ä»¤</th>
<th align="left">ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong><code>START TRANSACTION</code></strong> (æˆ– <code>BEGIN</code>)</td>
<td align="left"><strong>å¼€å¯äº‹åŠ¡</strong>ã€‚å‘Šè¯‰ MySQLï¼šâ€œä»è¿™ä¸€è¡Œå¼€å§‹ï¼Œåé¢çš„æ“ä½œå…ˆåˆ«çœŸå†™å…¥ç¡¬ç›˜ï¼Œå…ˆè®°åœ¨å°æœ¬æœ¬ä¸Šã€‚â€</td>
</tr>
<tr>
<td align="left"><strong><code>COMMIT</code></strong></td>
<td align="left"><strong>æäº¤</strong>ã€‚å‘Šè¯‰ MySQLï¼šâ€œåˆšæ‰çš„æ“ä½œéƒ½ç¡®è®¤æ— è¯¯ï¼Œå…¨éƒ¨ç”Ÿæ•ˆï¼Œå†™å…¥ç¡¬ç›˜ï¼â€</td>
</tr>
<tr>
<td align="left"><strong><code>ROLLBACK</code></strong></td>
<td align="left"><strong>å›æ»š</strong>ã€‚å‘Šè¯‰ MySQLï¼šâ€œå‡ºäº‹äº†ï¼åˆšæ‰çš„æ“ä½œå…¨éƒ¨ä½œåºŸï¼Œæ’¤é”€åˆ°å¼€å¯äº‹åŠ¡ä¹‹å‰çš„çŠ¶æ€ï¼â€</td>
</tr>
<tr>
<td align="left"><strong><code>savepoint</code></strong></td>
<td align="left"><strong>è®¾ç½®ä¸€ä¸ªå­˜æ¡£</strong>ã€‚å‘Šè¯‰Mysqlåœ¨è¿™é‡Œä¿å­˜ä¸€ä¸ªçŠ¶æ€ã€‚å¦‚æœå›æ»šçš„è¯å¯ä»¥é€‰æ‹©å›æ»šåˆ°è¿™é‡Œ</td>
</tr>
</tbody></table>
<p>æ³¨æ„ï¼šäº‹åŠ¡æ˜¯æœ‰é€‚ç”¨èŒƒå›´çš„</p>
<ul>
<li><strong>èƒ½å›æ»šçš„ï¼ˆDML - Data Manipulation Languageï¼‰</strong>ï¼š<ul>
<li><code>INSERT</code>ï¼ˆå¢ï¼‰</li>
<li><code>UPDATE</code>ï¼ˆæ”¹ï¼‰</li>
<li><code>DELETE</code>ï¼ˆåˆ æ•°æ®ï¼‰</li>
</ul>
</li>
<li><strong>ä¸èƒ½å›æ»šä¸”ä¼šå¼ºåˆ¶æäº¤çš„ï¼ˆDDL - Data Definition Languageï¼‰</strong>ï¼š<ul>
<li><code>CREATE</code>ï¼ˆå»ºè¡¨&#x2F;åº“ï¼‰</li>
<li><code>DROP</code>ï¼ˆåˆ è¡¨&#x2F;åº“ï¼‰</li>
<li><code>ALTER</code>ï¼ˆæ”¹å­—æ®µï¼‰</li>
<li><code>TRUNCATE</code>ï¼ˆæ¸…ç©ºè¡¨ï¼‰</li>
</ul>
</li>
</ul>
<p>æ¯”å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">MySQL  localhost:3306  mall_db_simple  SQL &gt; start transaction;</span><br><span class="line">Query OK, 0 rows affected (0.0001 sec)</span><br><span class="line">MySQL  localhost:3306  mall_db_simple  â˜…  SQL &gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mall_db_simple     |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows in set (0.0008 sec)</span><br><span class="line">MySQL  localhost:3306  mall_db_simple  â˜…  SQL &gt; drop database mall_db_simple;</span><br><span class="line">Query OK, 4 rows affected (0.0082 sec)</span><br><span class="line">MySQL  localhost:3306  mall_db_simple  SQL &gt; rollback;</span><br><span class="line">Query OK, 0 rows affected (0.0002 sec)</span><br><span class="line">MySQL  localhost:3306  mall_db_simple  SQL &gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line">4 rows in set (0.0006 sec)</span><br></pre></td></tr></table></figure>

<p>Mysqlåœ¨æ‰§è¡ŒDDLæŒ‡ä»¤å‰ï¼Œä¸ä¼šç®¡å‰é¢æœ‰æ²¡æœ‰<code>start transaction;</code>éƒ½ä¼šå…ˆæ‰§è¡Œä¸€ä¸ª<code>COMMIT</code>ï¼Œç„¶åå†ä¼šæ‰§è¡ŒDDLæŒ‡ä»¤ã€‚æ‰§è¡Œå®ŒDDLåå†ä¼šæ‰§è¡Œä¸€ä¸ª<code>COMMIT</code>ã€‚åç»­çš„<code>rollback</code>æ»šä¸å›æ¥</p>
<h3 id="DELETEå’ŒTRUNCATEçš„åŒºåˆ«"><a href="#DELETEå’ŒTRUNCATEçš„åŒºåˆ«" class="headerlink" title="DELETEå’ŒTRUNCATEçš„åŒºåˆ«"></a>DELETEå’ŒTRUNCATEçš„åŒºåˆ«</h3><ul>
<li><strong>æƒ³æ¸…ç©ºä¸€å¼ è¡¨ï¼Œä¸”å¸Œæœ›å¯ä»¥å›æ»šï¼š</strong><ul>
<li>ç”¨ <strong><code>DELETE FROM users;</code></strong></li>
<li>è¿™æ˜¯ DMLï¼Œé€Ÿåº¦æ…¢ï¼ˆä¸€è¡Œè¡Œåˆ ï¼‰ï¼Œä½†<strong>å¯ä»¥ <code>ROLLBACK</code></strong>ã€‚</li>
</ul>
</li>
<li><strong>æƒ³æ¸…ç©ºä¸€å¼ è¡¨ï¼Œä¸ç•™åè·¯ï¼š</strong><ul>
<li>ç”¨ <strong><code>TRUNCATE TABLE users;</code></strong></li>
<li>è¿™æ˜¯ DDLï¼Œé€Ÿåº¦å¿«ï¼ˆç›´æ¥æŠŠè¡¨æ–‡ä»¶æ‰”äº†é‡æ–°å»ºä¸€ä¸ªï¼‰ï¼Œä½†<strong>ROLLBACKä¸å›æ¥</strong>ã€‚</li>
</ul>
</li>
</ul>
<h2 id="å¼€å§‹äº‹åŠ¡ä¹‹å‰"><a href="#å¼€å§‹äº‹åŠ¡ä¹‹å‰" class="headerlink" title="å¼€å§‹äº‹åŠ¡ä¹‹å‰"></a>å¼€å§‹äº‹åŠ¡ä¹‹å‰</h2><h3 id="åº“å­˜æ˜¯æ€ä¹ˆè¢«ä¸‹å•æ“ä½œæä¹±çš„ï¼Ÿ"><a href="#åº“å­˜æ˜¯æ€ä¹ˆè¢«ä¸‹å•æ“ä½œæä¹±çš„ï¼Ÿ" class="headerlink" title="åº“å­˜æ˜¯æ€ä¹ˆè¢«ä¸‹å•æ“ä½œæä¹±çš„ï¼Ÿ"></a>åº“å­˜æ˜¯æ€ä¹ˆè¢«ä¸‹å•æ“ä½œæä¹±çš„ï¼Ÿ</h3><p>å…ˆçœ‹çœ‹idä¸º1çš„å•†å“æœ‰å¤šå°‘ä¸ªåº“å­˜</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> id, stock <span class="keyword">FROM</span> products <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œå¾—åˆ°ç»“æœå‰©ä½™100ä¸ª</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">MySQL  localhost:3306  mall_db_simple  SQL &gt; SELECT id, stock FROM products WHERE id = 1;</span><br><span class="line">+----+-------+</span><br><span class="line">| id | stock |</span><br><span class="line">+----+-------+</span><br><span class="line">|  1 |   100 |</span><br><span class="line">+----+-------+</span><br><span class="line">1 row in set (0.0003 sec)</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶ä¸€ä½æ­£å¸¸ç”¨æˆ·è¿›æ¥ä¹°äº†ä¸€ä¸ªidä¸º1çš„å•†å“</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> products <span class="keyword">SET</span> stock <span class="operator">=</span> stock <span class="operator">-</span> <span class="number">1</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>è¿™æ—¶å€™åº“å­˜è¿˜å‰©99ä¸ª</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">MySQL  localhost:3306  mall_db_simple  SQL &gt; SELECT id, stock FROM products WHERE id = 1;</span><br><span class="line">+----+-------+</span><br><span class="line">| id | stock |</span><br><span class="line">+----+-------+</span><br><span class="line">|  1 |    99 |</span><br><span class="line">+----+-------+</span><br><span class="line">1 row in set (0.0004 sec) sec)</span><br></pre></td></tr></table></figure>

<p>ç„¶åä¸€ä½æµ‹è¯•è¿›æ¥ä¹°äº†-1ä¸ªidä¸º1çš„å•†å“</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> products <span class="keyword">SET</span> stock <span class="operator">=</span> stock <span class="operator">-</span> (<span class="number">-1</span>) <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>åº“å­˜å¢åŠ äº†ï¼</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">MySQL  localhost:3306  mall_db_simple  SQL &gt; UPDATE products SET stock = stock - (-1) WHERE id = 1;</span><br><span class="line">Query OK, 1 row affected (0.0010 sec)</span><br><span class="line"></span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line">MySQL  localhost:3306  mall_db_simple  SQL &gt; SELECT id, stock FROM products WHERE id = 1;</span><br><span class="line">+----+-------+</span><br><span class="line">| id | stock |</span><br><span class="line">+----+-------+</span><br><span class="line">|  1 |   100 |</span><br><span class="line">+----+-------+</span><br><span class="line">1 row in set (0.0004 sec)</span><br></pre></td></tr></table></figure>

<p>ç„¶åè¿™ä½æµ‹è¯•ä¹°äº†9999ä¸ªå•†å“</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> products <span class="keyword">SET</span> stock <span class="operator">=</span> stock <span class="operator">-</span> <span class="number">9999</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>ç„¶åä»–ä¹°åˆ°äº†9999ä¸ªå•†å“å¹¶ä¸”æŠŠåº“å­˜å¹²æˆè´Ÿæ•°äº†ï¼Œå•†åŸè¶…å–äº†</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">MySQL  localhost:3306  mall_db_simple  SQL &gt; UPDATE products SET stock = stock - 9999 WHERE id = 1;</span><br><span class="line">Query OK, 1 row affected (0.0010 sec)</span><br><span class="line"></span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line">MySQL  localhost:3306  mall_db_simple  SQL &gt; SELECT id, stock FROM products WHERE id = 1;</span><br><span class="line">+----+-------+</span><br><span class="line">| id | stock |</span><br><span class="line">+----+-------+</span><br><span class="line">|  1 | -9899 |</span><br><span class="line">+----+-------+</span><br><span class="line">1 row in set (0.0004 sec)</span><br></pre></td></tr></table></figure>

<h3 id="è§£å†³æ–¹æ³•"><a href="#è§£å†³æ–¹æ³•" class="headerlink" title="è§£å†³æ–¹æ³•"></a>è§£å†³æ–¹æ³•</h3><p>åˆ©ç”¨UPDATE è¯­å¥çš„åŸå­æ€§ï¼ŒæŠŠâ€œåˆ¤æ–­â€é€»è¾‘ç›´æ¥å†™åœ¨ SQL é‡Œã€‚</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> products </span><br><span class="line"><span class="keyword">SET</span> stock <span class="operator">=</span> stock <span class="operator">-</span> è´­ä¹°æ•°é‡</span><br><span class="line"><span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span> </span><br><span class="line"><span class="keyword">AND</span> stock <span class="operator">&gt;=</span> è´­ä¹°æ•°é‡;</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·çš„æ‰§è¡Œæ•ˆæœæ˜¯</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">MySQL  localhost:3306  mall_db_simple  SQL &gt; UPDATE products SET stock = stock - 9999 WHERE id = 1 AND stock &gt;= 9999;</span><br><span class="line">Query OK, 0 rows affected (0.0009 sec)</span><br><span class="line"></span><br><span class="line">Rows matched: 0  Changed: 0  Warnings: 0</span><br><span class="line">MySQL  localhost:3306  mall_db_simple  SQL &gt; SELECT id, stock FROM products WHERE id = 1;</span><br><span class="line">+----+-------+</span><br><span class="line">| id | stock |</span><br><span class="line">+----+-------+</span><br><span class="line">|  1 |   100 |</span><br><span class="line">+----+-------+</span><br><span class="line">1 row in set (0.0003 sec)</span><br></pre></td></tr></table></figure>

<p><strong>æ•ˆæœï¼š</strong></p>
<ul>
<li><strong>åº“å­˜å¤Ÿ</strong>ï¼šMySQL æ‰¾åˆ°è¿™è¡Œæ•°æ®ï¼Œä¸”æ¡ä»¶æ»¡è¶³ï¼Œæ‰§è¡Œæ‰£å‡ã€‚è¿”å› <strong><code>Rows matched: 1, Changed: 1</code></strong>ã€‚åç«¯çœ‹åˆ°å½±å“è¡Œæ•°ä¸º 1ï¼Œåˆ¤å®šè´­ä¹°æˆåŠŸã€‚</li>
<li><strong>åº“å­˜ä¸å¤Ÿ</strong>ï¼ˆæ¯”å¦‚åº“å­˜æ˜¯ 100ï¼‰ï¼šMySQL æ‰«è¿™è¡Œæ•°æ®ï¼Œå‘ç° <code>stock &gt;= 9991</code> ä¸æˆç«‹ã€‚ç›´æ¥æ”¾å¼ƒä¿®æ”¹ã€‚è¿”å› <strong><code>Rows matched: 0, Changed: 0</code></strong>ã€‚åç«¯çœ‹åˆ°å½±å“è¡Œæ•°ä¸º 0ï¼Œåˆ¤å®š<strong>åº“å­˜ä¸è¶³ï¼Œä¸‹å•å¤±è´¥</strong>ã€‚</li>
</ul>
<p>åŒæ ·çš„æ–¹æ³•è§£å†³ä¹°äº†-1ä¸ªå•†å“å¯¼è‡´åº“å­˜å¢åŠ çš„é—®é¢˜ï¼Œå†æ·»åŠ ä¸€ä¸ªANDåˆ¤æ–­é€»è¾‘</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> products </span><br><span class="line"><span class="keyword">SET</span> stock <span class="operator">=</span> stock <span class="operator">-</span> è´­ä¹°æ•°é‡</span><br><span class="line"><span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span> </span><br><span class="line"><span class="keyword">AND</span> stock <span class="operator">&gt;=</span> è´­ä¹°æ•°é‡</span><br><span class="line"><span class="keyword">AND</span> è´­ä¹°æ•°é‡ <span class="operator">&gt;</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·å½“è´­ä¹°æ•°é‡ä¸º-1çš„æ—¶å€™</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">MySQL  localhost:3306  mall_db_simple  SQL &gt; UPDATE products SET stock = stock - (-1) WHERE id = 1 AND stock &gt;= (-1) AND (-1) &gt; 0;</span><br><span class="line">Query OK, 0 rows affected (0.0010 sec)</span><br><span class="line"></span><br><span class="line">Rows matched: 0  Changed: 0  Warnings: 0</span><br><span class="line">MySQL  localhost:3306  mall_db_simple  SQL &gt; SELECT id, stock FROM products WHERE id = 1;</span><br><span class="line">+----+-------+</span><br><span class="line">| id | stock |</span><br><span class="line">+----+-------+</span><br><span class="line">|  1 |   100 |</span><br><span class="line">+----+-------+</span><br><span class="line">1 row in set (0.0004 sec)</span><br></pre></td></tr></table></figure>

<p>åŒæ ·ï¼Œ0è¡Œè¢«matchï¼Œ0è¡Œè¢«change</p>
<h3 id="æ²¡ç”¨çš„è§£å†³æ–¹æ³•"><a href="#æ²¡ç”¨çš„è§£å†³æ–¹æ³•" class="headerlink" title="æ²¡ç”¨çš„è§£å†³æ–¹æ³•"></a>æ²¡ç”¨çš„è§£å†³æ–¹æ³•</h3><p>åç«¯æ£€æµ‹åº“å­˜æ•°é‡æ˜¯å¦å……è¶³ï¼Œå†æ‰§è¡Œæ‰£åº“å­˜ï¼Ÿ</p>
<p>å‡è®¾åº“å­˜åªæœ‰ <strong>1 ä¸ª</strong>ã€‚<br>User Aå’ŒUser B<strong>åŒæ—¶</strong>ç‚¹å‡»è´­ä¹°ã€‚<br><strong>åç«¯ä»£ç ï¼ˆé”™è¯¯ç¤ºèŒƒï¼‰ï¼š</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. å…ˆæŸ¥åº“å­˜</span></span><br><span class="line">current_stock = db.query(<span class="string">&quot;SELECT stock FROM products WHERE id=1&quot;</span>)</span><br><span class="line"><span class="comment"># 2. åˆ¤æ–­å……è¶³</span></span><br><span class="line"><span class="keyword">if</span> current_stock &gt; <span class="number">0</span>:</span><br><span class="line"> <span class="comment"># 3. æ‰£åº“å­˜</span></span><br><span class="line"> db.<span class="built_in">exec</span>(<span class="string">&quot;UPDATE products SET stock = stock - 1 WHERE id=1&quot;</span>)</span><br><span class="line"> <span class="keyword">return</span> <span class="string">&quot;è´­ä¹°æˆåŠŸ&quot;</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line"> <span class="keyword">return</span> <span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span></span><br></pre></td></tr></table></figure>

<p>è¶…å–è¿‡ç¨‹ï¼š</p>
<ol>
<li><strong>æ—¶åˆ» 0.01s</strong>ï¼šA æŸ¥åº“å­˜ï¼Œæ˜¯ 1ã€‚</li>
<li><strong>æ—¶åˆ» 0.01s</strong>ï¼šB æŸ¥åº“å­˜ï¼Œä¹Ÿæ˜¯ 1ï¼ˆå› ä¸º A è¿˜æ²¡æ‰£å‘¢ï¼‰ã€‚</li>
<li><strong>æ—¶åˆ» 0.02s</strong>ï¼šA åˆ¤æ–­ <code>1 &gt; 0</code>ï¼Œé€šè¿‡ã€‚</li>
<li><strong>æ—¶åˆ» 0.02s</strong>ï¼šB åˆ¤æ–­ <code>1 &gt; 0</code>ï¼Œé€šè¿‡ã€‚</li>
<li><strong>æ—¶åˆ» 0.03s</strong>ï¼šA æ‰£å‡ï¼Œåº“å­˜å˜ 0ã€‚</li>
<li><strong>æ—¶åˆ» 0.03s</strong>ï¼šB æ‰£å‡ï¼Œåº“å­˜å˜ -1ã€‚<br>ç»“æœï¼šå–å‡ºäº† 2 ä¸ªæ‰‹æœºï¼Œå®é™…ä¸Šä»“åº“åªæœ‰ 1 ä¸ªã€‚è¶…å–äº†ã€‚</li>
</ol>
<h3 id="å¦‚æœè¦æ±‚åº“å­˜ä¸èƒ½ä¸ºè´Ÿæ•°ï¼Ÿ"><a href="#å¦‚æœè¦æ±‚åº“å­˜ä¸èƒ½ä¸ºè´Ÿæ•°ï¼Ÿ" class="headerlink" title="å¦‚æœè¦æ±‚åº“å­˜ä¸èƒ½ä¸ºè´Ÿæ•°ï¼Ÿ"></a>å¦‚æœè¦æ±‚åº“å­˜ä¸èƒ½ä¸ºè´Ÿæ•°ï¼Ÿ</h3><p>åœ¨MySQL 8.0.16+ä½¿ç”¨Checkçº¦æŸæ˜¯å¯è¡Œçš„</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER TABLE</span> products</span><br><span class="line"><span class="keyword">ADD CONSTRAINT</span> chk_stock_non_negative</span><br><span class="line"><span class="keyword">CHECK</span> (stock <span class="operator">&gt;=</span> <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p>ä¹‹åå†å°è¯•æ‰£é™¤è¶…è¿‡åº“å­˜çš„æ•°çš„æ—¶å€™</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> products <span class="keyword">SET</span> stock <span class="operator">=</span> stock <span class="operator">-</span> <span class="number">9999</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>å°±ä¼šç›´æ¥æŠ¥é”™</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR 3819 (HY000): Check constraint &#x27;chk_stock_non_negative&#x27; is violated</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯è¦æ³¨æ„ï¼ŒCHECK æ˜¯å…œåº•ï¼Œä¸æ˜¯ä¸»æµç¨‹ã€‚å› ä¸ºæŠ¥é”™æˆæœ¬é«˜ï¼Œä¸æ–¹ä¾¿åŒºåˆ†â€œåº“å­˜ä¸è¶³ vs å…¶ä»–é”™è¯¯â€ï¼Œè€Œä¸”åœ¨é«˜å¹¶å‘ä¸‹ï¼Œå¼‚å¸¸æ¯” affected_rows æ…¢</p>
<p>å¦‚æœä½¿ç”¨UNSIGNEDï¼Ÿè¡¨é¢çœ‹èµ·æ¥å¯è¡Œï¼Œä½†ä¸æ¨è</p>
<p>åœ¨æŸäº›ç‰ˆæœ¬ &#x2F; SQL_MODE ä¸‹ï¼šè¦ä¹ˆæŠ¥é”™ï¼Œè¦ä¹ˆå‘ç”Ÿéšå¼ç±»å‹è½¬æ¢ï¼Œè¡Œä¸ºä¸ç¨³å®š</p>
<p>UNSIGNED è§£å†³çš„æ˜¯â€œå€¼åŸŸâ€ï¼Œä¸æ˜¯å¹¶å‘é€»è¾‘</p>
<p>æ€»ä¹‹åœ¨åç«¯é€»è¾‘å’ŒSQLè¯­å¥çš„ç¼–å†™ä¸­ï¼Œå¯¹äºå‡¡æ˜¯èƒ½å‚ä¸åŠ å‡ä¹˜é™¤çš„å­—æ®µï¼Œéƒ½å‡è®¾æœ‰äººä¼šä¼ è´Ÿæ•°ã€é›¶ã€æå¤§å€¼</p>
<h2 id="ä½¿ç”¨äº‹åŠ¡"><a href="#ä½¿ç”¨äº‹åŠ¡" class="headerlink" title="ä½¿ç”¨äº‹åŠ¡"></a>ä½¿ç”¨äº‹åŠ¡</h2><h3 id="å›æ»šçš„ä½¿ç”¨"><a href="#å›æ»šçš„ä½¿ç”¨" class="headerlink" title="å›æ»šçš„ä½¿ç”¨"></a>å›æ»šçš„ä½¿ç”¨</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">MySQL  localhost:3306  mall_db_simple  SQL &gt; SELECT id, stock FROM products WHERE id = 1;</span><br><span class="line">+----+-------+</span><br><span class="line">| id | stock |</span><br><span class="line">+----+-------+</span><br><span class="line">|  1 |    99 |</span><br><span class="line">+----+-------+</span><br><span class="line">1 row in set (0.0039 sec)</span><br><span class="line">MySQL  localhost:3306  mall_db_simple  SQL &gt; START TRANSACTION;</span><br><span class="line">Query OK, 0 rows affected (0.0002 sec)</span><br><span class="line">MySQL  localhost:3306  mall_db_simple  â˜…  SQL &gt; UPDATE products SET stock = stock - 1 WHERE id = 1;</span><br><span class="line">Query OK, 1 row affected (0.0015 sec)</span><br><span class="line"></span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line">MySQL  localhost:3306  mall_db_simple  â˜…  SQL &gt; SELECT id, stock FROM products WHERE id = 1;</span><br><span class="line">+----+-------+</span><br><span class="line">| id | stock |</span><br><span class="line">+----+-------+</span><br><span class="line">|  1 |    98 |</span><br><span class="line">+----+-------+</span><br><span class="line">1 row in set (0.0003 sec)</span><br><span class="line">MySQL  localhost:3306  mall_db_simple  â˜…  SQL &gt; ROLLBACK;</span><br><span class="line">Query OK, 0 rows affected (0.0072 sec)</span><br><span class="line">MySQL  localhost:3306  mall_db_simple  SQL &gt; SELECT id, stock FROM products WHERE id = 1;</span><br><span class="line">+----+-------+</span><br><span class="line">| id | stock |</span><br><span class="line">+----+-------+</span><br><span class="line">|  1 |    99 |</span><br><span class="line">+----+-------+</span><br><span class="line">1 row in set (0.0003 sec)</span><br></pre></td></tr></table></figure>

<p>å¯è§ï¼Œå¼€å§‹ä¹‹å‰ï¼Œidä¸º1çš„å•†å“åº“å­˜99ä¸ªã€‚ç„¶åå¯åŠ¨äº‹åŠ¡ï¼Œå°†å•†å“æ•°é‡æ‰£é™¤1ä¸ªåï¼Œå†æ¬¡æŸ¥çœ‹å•†å“æ•°é‡å·²ç»å˜æˆ98ä¸ªäº†ã€‚ç„¶åä½¿ç”¨å›æ»šã€‚å•†å“æ•°é‡æ²¡æœ‰å˜åŒ–</p>
<h3 id="æäº¤çš„ä½¿ç”¨"><a href="#æäº¤çš„ä½¿ç”¨" class="headerlink" title="æäº¤çš„ä½¿ç”¨"></a>æäº¤çš„ä½¿ç”¨</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">MySQL  localhost:3306  mall_db_simple  SQL &gt; SELECT id, stock FROM products WHERE id = 1;</span><br><span class="line">+----+-------+</span><br><span class="line">| id | stock |</span><br><span class="line">+----+-------+</span><br><span class="line">|  1 |    99 |</span><br><span class="line">+----+-------+</span><br><span class="line">1 row in set (0.0025 sec)</span><br><span class="line">MySQL  localhost:3306  mall_db_simple  SQL &gt; begin;</span><br><span class="line">Query OK, 0 rows affected (0.0002 sec)</span><br><span class="line">MySQL  localhost:3306  mall_db_simple  â˜…  SQL &gt; UPDATE products SET stock = stock - 2 WHERE id = 1;</span><br><span class="line">Query OK, 1 row affected (0.0005 sec)</span><br><span class="line"></span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line">MySQL  localhost:3306  mall_db_simple  â˜…  SQL &gt; SELECT id, stock FROM products WHERE id = 1;</span><br><span class="line">+----+-------+</span><br><span class="line">| id | stock |</span><br><span class="line">+----+-------+</span><br><span class="line">|  1 |    97 |</span><br><span class="line">+----+-------+</span><br><span class="line">1 row in set (0.0003 sec)</span><br><span class="line">MySQL  localhost:3306  mall_db_simple  â˜…  SQL &gt; commit;</span><br><span class="line">Query OK, 0 rows affected (0.0045 sec)</span><br><span class="line">MySQL  localhost:3306  mall_db_simple  SQL &gt; SELECT id, stock FROM products WHERE id = 1;</span><br><span class="line">+----+-------+</span><br><span class="line">| id | stock |</span><br><span class="line">+----+-------+</span><br><span class="line">|  1 |    97 |</span><br><span class="line">+----+-------+</span><br><span class="line">1 row in set (0.0003 sec)</span><br></pre></td></tr></table></figure>

<p>å¯è§ï¼Œå¼€å§‹ä¹‹å‰ï¼Œidä¸º1çš„å•†å“åº“å­˜99ä¸ªã€‚ç„¶åå¯åŠ¨äº‹åŠ¡ï¼Œå°†å•†å“æ•°é‡æ‰£é™¤2ä¸ªåï¼Œå†æ¬¡æŸ¥çœ‹å•†å“æ•°é‡å·²ç»å˜æˆ97ä¸ªäº†ã€‚ä½¿ç”¨commitæäº¤åï¼Œäº‹åŠ¡ç»“æŸã€‚å•†å“åº“å­˜æ‰£é™¤</p>
<h3 id="ä¿å­˜ç‚¹çš„ä½¿ç”¨"><a href="#ä¿å­˜ç‚¹çš„ä½¿ç”¨" class="headerlink" title="ä¿å­˜ç‚¹çš„ä½¿ç”¨"></a>ä¿å­˜ç‚¹çš„ä½¿ç”¨</h3><p>åœ¨åŒä¸€äº‹åŠ¡ä¸­ï¼Œä¿å­˜ç‚¹åç§°æ˜¯å”¯ä¸€çš„ã€‚å¦‚æœè®¾ç½®ç›¸åŒåç§°çš„ä¿å­˜ç‚¹åç§°ï¼Œåè®¾ç½®çš„ä¿å­˜ç‚¹ä¼šè¦†ç›–å…ˆè®¾ç½®çš„</p>
<p>çœ‹ä¸‹é¢çš„ä¾‹å­</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">MySQL  localhost:3306  mall_db_simple  SQL &gt; begin;</span><br><span class="line">Query OK, 0 rows affected (0.0002 sec)</span><br><span class="line">MySQL  localhost:3306  mall_db_simple  â˜…  SQL &gt; SELECT id, stock FROM products WHERE id = 1;</span><br><span class="line">+----+-------+</span><br><span class="line">| id | stock |</span><br><span class="line">+----+-------+</span><br><span class="line">|  1 |   100 |</span><br><span class="line">+----+-------+</span><br><span class="line">1 row in set (0.0003 sec)</span><br><span class="line">MySQL  localhost:3306  mall_db_simple  â˜…  SQL &gt; UPDATE products SET stock = stock - 10 WHERE id = 1;</span><br><span class="line">Query OK, 1 row affected (0.0004 sec)</span><br><span class="line"></span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line">MySQL  localhost:3306  mall_db_simple  â˜…  SQL &gt; SELECT id, stock FROM products WHERE id = 1;</span><br><span class="line">+----+-------+</span><br><span class="line">| id | stock |</span><br><span class="line">+----+-------+</span><br><span class="line">|  1 |    90 |</span><br><span class="line">+----+-------+</span><br><span class="line">1 row in set (0.0003 sec)</span><br><span class="line">MySQL  localhost:3306  mall_db_simple  â˜…  SQL &gt; savepoint koukuncun1;</span><br><span class="line">Query OK, 0 rows affected (0.0002 sec)</span><br><span class="line">MySQL  localhost:3306  mall_db_simple  â˜…  SQL &gt; UPDATE products SET stock = stock - 20 WHERE id = 1;</span><br><span class="line">Query OK, 1 row affected (0.0003 sec)</span><br><span class="line"></span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line">MySQL  localhost:3306  mall_db_simple  â˜…  SQL &gt; SELECT id, stock FROM products WHERE id = 1;</span><br><span class="line">+----+-------+</span><br><span class="line">| id | stock |</span><br><span class="line">+----+-------+</span><br><span class="line">|  1 |    70 |</span><br><span class="line">+----+-------+</span><br><span class="line">1 row in set (0.0003 sec)</span><br><span class="line">MySQL  localhost:3306  mall_db_simple  â˜…  SQL &gt; savepoint koukuncun2;</span><br><span class="line">Query OK, 0 rows affected (0.0002 sec)</span><br><span class="line">MySQL  localhost:3306  mall_db_simple  â˜…  SQL &gt; rollback to koukuncun1;</span><br><span class="line">Query OK, 0 rows affected (0.0003 sec)</span><br><span class="line">MySQL  localhost:3306  mall_db_simple  â˜…  SQL &gt; SELECT id, stock FROM products WHERE id = 1;</span><br><span class="line">+----+-------+</span><br><span class="line">| id | stock |</span><br><span class="line">+----+-------+</span><br><span class="line">|  1 |    90 |</span><br><span class="line">+----+-------+</span><br><span class="line">1 row in set (0.0002 sec)</span><br><span class="line">MySQL  localhost:3306  mall_db_simple  â˜…  SQL &gt; rollback to koukuncun2;</span><br><span class="line">ERROR: 1305 (42000): SAVEPOINT koukuncun2 does not exist</span><br><span class="line">MySQL  localhost:3306  mall_db_simple  â˜…  SQL &gt; release savepoint koukuncun1;</span><br><span class="line">Query OK, 0 rows affected (0.0002 sec)</span><br><span class="line">MySQL  localhost:3306  mall_db_simple  â˜…  SQL &gt; UPDATE products SET stock = stock - 20 WHERE id = 1;</span><br><span class="line">Query OK, 1 row affected (0.0004 sec)</span><br><span class="line"></span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line">MySQL  localhost:3306  mall_db_simple  â˜…  SQL &gt; SELECT id, stock FROM products WHERE id = 1;</span><br><span class="line">+----+-------+</span><br><span class="line">| id | stock |</span><br><span class="line">+----+-------+</span><br><span class="line">|  1 |    70 |</span><br><span class="line">+----+-------+</span><br><span class="line">1 row in set (0.0003 sec)</span><br><span class="line">MySQL  localhost:3306  mall_db_simple  â˜…  SQL &gt; rollback to koukuncun1;</span><br><span class="line">ERROR: 1305 (42000): SAVEPOINT koukuncun1 does not exist</span><br></pre></td></tr></table></figure>

<p>ä¸€ä¸ªä¼šè¯é‡Œå¯ä»¥è®¾ç½®å¤šä¸ªä¿å­˜ç‚¹ã€‚å¹¶ä¸”å¯ä»¥é€šè¿‡<code>rollback to ä¿å­˜ç‚¹</code>å›åˆ°ä¿å­˜ç‚¹ã€‚</p>
<p>ä½†æ˜¯ï¼Œä¿å­˜ç‚¹ä¸æ˜¯å˜é‡ã€‚å°±æ¯”å¦‚ä¸Šé¢çš„ä¾‹å­ï¼Œåˆ›å»ºäº†ä¿å­˜ç‚¹<code>koukuncun1</code>ååˆåˆ›å»ºäº†ä¿å­˜ç‚¹<code>koukuncun2</code>ã€‚ç„¶åç›´æ¥å›æ»šåˆ°äº†<code>koukuncun1</code>ã€‚è¿™æ—¶å€™å°±ä¸èƒ½å†å›æ»šåˆ°<code>koukuncun2</code>äº†ï¼Œå› ä¸º<code>koukuncun2</code>å¯¹äº<code>koukuncun1</code>æ¥è¯´æ˜¯æœªæ¥å‘ç”Ÿçš„ã€‚<br>ä¹Ÿå¯ä»¥ä½¿ç”¨<code>release savepoint ä¿å­˜ç‚¹</code>æŒ‡ä»¤æ¥é‡Šæ”¾ä¿å­˜ç‚¹ã€‚é‡Šæ”¾åçš„ä¿å­˜ç‚¹åŒæ ·ä¸èƒ½å†å›æ»šã€‚</p>
<h2 id="è‡ªåŠ¨æäº¤ï¼Ÿæ‰‹åŠ¨æäº¤ï¼Ÿ"><a href="#è‡ªåŠ¨æäº¤ï¼Ÿæ‰‹åŠ¨æäº¤ï¼Ÿ" class="headerlink" title="è‡ªåŠ¨æäº¤ï¼Ÿæ‰‹åŠ¨æäº¤ï¼Ÿ"></a>è‡ªåŠ¨æäº¤ï¼Ÿæ‰‹åŠ¨æäº¤ï¼Ÿ</h2><ol>
<li>ä»€ä¹ˆæ˜¯è‡ªåŠ¨æäº¤ï¼ˆé»˜è®¤ï¼‰ï¼Ÿ<br>æ•²ä¸€è¡Œ SQLï¼Œå›è½¦ï¼ŒMySQL ç«‹åˆ»æŠŠå®ƒå­˜è¿›ç¡¬ç›˜ï¼ˆCommitï¼‰ã€‚</li>
</ol>
<ul>
<li><strong>çŠ¶æ€</strong>ï¼š<code>autocommit = 1</code> (å¼€å¯)</li>
<li><strong>åœºæ™¯</strong>ï¼šå¹³æ—¶åœ¨å‘½ä»¤è¡Œé‡Œæ•² <code>UPDATE ...</code>ï¼Œæ²¡æ•² <code>COMMIT</code> æ•°æ®ä¹Ÿæ”¹äº†ï¼Œå°±æ˜¯å› ä¸ºè¿™ä¸ªã€‚</li>
</ul>
<ol start="2">
<li>ä»€ä¹ˆæ˜¯æ‰‹åŠ¨æäº¤ï¼Ÿ<br>éœ€è¦æ˜¾å¼åœ°å‘Šè¯‰ MySQLï¼šâ€œæˆ‘è¦å¼€å§‹è®°è´¦äº†â€å’Œâ€œæˆ‘è®°å®Œè´¦äº†â€ã€‚</li>
</ol>
<ul>
<li><strong>çŠ¶æ€</strong>ï¼š<code>autocommit = 0</code> (å…³é—­)</li>
<li><strong>åœºæ™¯</strong>ï¼š<ul>
<li><strong>æ–¹æ³• Aï¼ˆæ¨èï¼Œä¸´æ—¶æ‰‹åŠ¨ï¼‰</strong>ï¼šè¾“å…¥ <code>START TRANSACTION</code>ã€‚æ­¤æ—¶ <code>autocommit</code> æš‚æ—¶å¤±æ•ˆï¼Œç›´åˆ°ä½ æ•² <code>COMMIT</code> æˆ– <code>ROLLBACK</code>ã€‚</li>
<li><strong>æ–¹æ³• Bï¼ˆå…¨å±€æ‰‹åŠ¨ï¼Œä¸æ¨èï¼‰</strong>ï¼šæ‰§è¡Œ <code>SET autocommit = 0;</code>ã€‚è¿™å¾ˆå±é™©ï¼å¦‚æœå¿˜äº†æ•² COMMITï¼Œåšäº†ä¸€å¤©çš„æ“ä½œï¼Œå…³æ‰çª—å£å<strong>å…¨éƒ½ä¼šä¸¢</strong>ã€‚</li>
</ul>
</li>
</ul>
<p>é€šè¿‡ä¸‹é¢çš„å‘½ä»¤æŸ¥çœ‹å½“å‰çŠ¶æ€</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@autocommit</span>;</span><br></pre></td></tr></table></figure>

<p>ä¸€èˆ¬éƒ½æ˜¯é»˜è®¤å¼€å¯äº†è‡ªåŠ¨æäº¤</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">MySQL  localhost:3306  mall_db_simple  SQL &gt; SELECT @@autocommit;</span><br><span class="line">+--------------+</span><br><span class="line">| @@autocommit |</span><br><span class="line">+--------------+</span><br><span class="line">|            1 |</span><br><span class="line">+--------------+</span><br><span class="line">1 row in set (0.0001 sec)</span><br></pre></td></tr></table></figure>

<h2 id="äº‹åŠ¡çš„éš”ç¦»çº§åˆ«"><a href="#äº‹åŠ¡çš„éš”ç¦»çº§åˆ«" class="headerlink" title="äº‹åŠ¡çš„éš”ç¦»çº§åˆ«"></a>äº‹åŠ¡çš„éš”ç¦»çº§åˆ«</h2><p>MySQL æä¾›äº† 4 ç§çº§åˆ«ï¼Œå®‰å…¨æ€§ä»ä½åˆ°é«˜ï¼Œæ€§èƒ½ä»é«˜åˆ°ä½ï¼š</p>
<table>
<thead>
<tr>
<th align="left">çº§åˆ«</th>
<th align="left">è‹±æ–‡å</th>
<th align="left">ç»°å·</th>
<th align="left">ç‰¹ç‚¹</th>
<th align="left">ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>1</strong></td>
<td align="left"><strong>Read Uncommitted</strong></td>
<td align="left"><strong>è¯»æœªæäº¤</strong></td>
<td align="left"><strong>è£¸å¥”</strong></td>
<td align="left">åˆ«äººè¿˜æ²¡ Commit çš„æ•°æ®å°±èƒ½çœ‹è§ã€‚ï¼ˆè„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯»ï¼‰</td>
</tr>
<tr>
<td align="left"><strong>2</strong></td>
<td align="left"><strong>Read Committed</strong></td>
<td align="left"><strong>è¯»å·²æäº¤ (RC)</strong></td>
<td align="left"><strong>åŠéš”ç¦»</strong></td>
<td align="left">åˆ«äºº Commit äº†ï¼Œæ‰èƒ½çœ‹è§ã€‚ï¼ˆå¹»è¯»å’Œä¸å¯é‡å¤è¯»ï¼‰</td>
</tr>
<tr>
<td align="left"><strong>3</strong></td>
<td align="left"><strong>Repeatable Read</strong></td>
<td align="left"><strong>å¯é‡å¤è¯» (RR)</strong></td>
<td align="left"><strong>ç…§éª—</strong></td>
<td align="left"><strong>MySQL é»˜è®¤</strong> äº‹åŠ¡ä¸€å¼€å§‹ï¼Œå°±æ‹ä¸ªç…§ã€‚ä¸ç®¡åˆ«äººæ€ä¹ˆæ”¹ï¼Œçœ‹åˆ°çš„æ°¸è¿œæ˜¯å¼€å§‹æ—¶çš„æ ·å­ã€‚</td>
</tr>
<tr>
<td align="left"><strong>4</strong></td>
<td align="left"><strong>Serializable</strong></td>
<td align="left"><strong>ä¸²è¡ŒåŒ–</strong></td>
<td align="left"><strong>æ’é˜Ÿ</strong></td>
<td align="left">åªè¦æˆ‘æ²¡æå®Œï¼Œåˆ«äººè¿æŸ¥éƒ½ä¸å‡†æŸ¥ã€‚<strong>æ…¢åˆ°ä»¤äººå‘æŒ‡</strong>ã€‚</td>
</tr>
</tbody></table>
<h3 id="é»˜è®¤å¯é‡å¤è¯»çš„åœºæ™¯"><a href="#é»˜è®¤å¯é‡å¤è¯»çš„åœºæ™¯" class="headerlink" title="é»˜è®¤å¯é‡å¤è¯»çš„åœºæ™¯"></a>é»˜è®¤å¯é‡å¤è¯»çš„åœºæ™¯</h3><p><strong>åœºæ™¯</strong>ï¼šï¼ˆçª—å£ Aï¼‰åœ¨æŸ¥è´¦ï¼Œï¼ˆçª—å£ Bï¼‰åœ¨æ”¹æ•°æ®ã€‚</p>
<ol>
<li><p><strong>çª—å£ A</strong>ï¼šå¼€å¯äº‹åŠ¡ï¼Œå…ˆæŸ¥ä¸€ä¸‹åº“å­˜ã€‚</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">SELECT</span> stock <span class="keyword">FROM</span> products <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>çª—å£ B</strong>ï¼šå¼€å¯äº‹åŠ¡ï¼Œå–æ‰ 50 ä¸ª</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> products <span class="keyword">SET</span> stock <span class="operator">=</span> <span class="number">50</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>çª—å£ A</strong>ï¼š<strong>å†æ¬¡æŸ¥è¯¢</strong>åº“å­˜ã€‚</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> stock <span class="keyword">FROM</span> products <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>ç»“æœ</strong>ï¼š<strong>è¿˜æ˜¯ 100ï¼</strong> (å“ªæ€•çª—å£ B å·²ç»æ”¹æˆ 50 äº†)</li>
<li><strong>åŸå› </strong>ï¼šè¿™å°±æ˜¯ <strong>Repeatable Read</strong>ã€‚åœ¨å¼€å¯äº‹åŠ¡çš„é‚£ä¸€åˆ»ï¼ŒMySQL ç»™ä»–ç”Ÿæˆäº†ä¸€ä¸ªâ€œå¿«ç…§â€ã€‚åªè¦ä¸ç»“æŸäº‹åŠ¡ï¼Œå¤–é¢çš„ä¸–ç•Œå¤©å´©åœ°è£‚ï¼Œä»–çœ‹åˆ°çš„æ°¸è¿œæ˜¯ 100ã€‚</li>
</ul>
</li>
<li><p><strong>çª—å£ A</strong>ï¼šç»“æŸæŸ¥è´¦ã€‚</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"><span class="keyword">SELECT</span> stock <span class="keyword">FROM</span> products <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">--ç»“æœï¼š50</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p>å¦‚æœçª—å£Aè¦è·å–å®æ—¶æ•°æ®ï¼Œå°±ä½¿ç”¨</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;</span><br></pre></td></tr></table></figure>

<h3 id="äº‹åŠ¡å¹¶å‘æ‰§è¡Œå¯èƒ½å¼•å‘çš„é—®é¢˜"><a href="#äº‹åŠ¡å¹¶å‘æ‰§è¡Œå¯èƒ½å¼•å‘çš„é—®é¢˜" class="headerlink" title="äº‹åŠ¡å¹¶å‘æ‰§è¡Œå¯èƒ½å¼•å‘çš„é—®é¢˜"></a>äº‹åŠ¡å¹¶å‘æ‰§è¡Œå¯èƒ½å¼•å‘çš„é—®é¢˜</h3><ol>
<li><strong>è„è¯» (Dirty Read)</strong>ï¼š<ul>
<li><em>ç°è±¡</em>ï¼šA è¯»åˆ°äº† B <strong>è¿˜æ²¡æäº¤</strong>çš„æ•°æ®ã€‚ç»“æœ B å›æ»šäº†ï¼ŒA è¯»åˆ°çš„æ˜¯å‡æ•°æ®ã€‚</li>
<li><em>è°æœ‰è¿™æ¯›ç—…</em>ï¼š<strong>Read Uncommitted</strong>ã€‚</li>
</ul>
</li>
<li><strong>ä¸å¯é‡å¤è¯» (Non-repeatable Read)</strong>ï¼š<ul>
<li><em>ç°è±¡</em>ï¼šA ç¬¬ä¸€æ¬¡è¯»æ˜¯ 100ï¼ŒB æ”¹æˆ 50 æäº¤äº†ï¼ŒA ç¬¬äºŒæ¬¡è¯»å˜æˆ 50ã€‚A æ‡µäº†ï¼šâ€œæ€ä¹ˆä¸€ä¼šå„¿ä¸€ä¸ªæ ·ï¼Ÿâ€</li>
<li><em>è°æœ‰è¿™æ¯›ç—…</em>ï¼š<strong>Read Committed</strong> ã€‚</li>
</ul>
</li>
<li><strong>å¹»è¯» (Phantom Read)</strong>ï¼š<ul>
<li><em>ç°è±¡</em>ï¼šA æŸ¥æ‰€æœ‰è®¢å•ï¼Œå‘ç°æœ‰ 5 ä¸ªã€‚B å·å·<strong>æ’å…¥</strong>äº†ä¸€ä¸ªæ–°è®¢å•ã€‚A å‡†å¤‡ä¿®æ”¹è¿™ 5 ä¸ªè®¢å•ï¼Œç»“æœå‘ç°æ•°æ®åº“é‡Œæœ‰ 6 ä¸ªè®¢å•å—å½±å“ã€‚A è§‰å¾—å‡ºç°äº†å¹»è§‰ã€‚</li>
</ul>
</li>
</ol>
<p>åœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹<strong>ä¿æŒé»˜è®¤ (Repeatable Read)</strong> å°±è¡Œ</p>
<p>MySQL çš„é»˜è®¤è®¾ç½®å·²ç»éå¸¸ä¼˜ç§€ï¼Œèƒ½é¿å…å¤§å¤šæ•°å¹¶å‘å‘ã€‚</p>
<p>åªæœ‰åœ¨æå°‘æ•°å¯¹â€œå®æ—¶æ€§â€è¦æ±‚æé«˜ï¼Œä¸”ä¸ºäº†å‡å°‘æ­»é”çš„åœºæ™¯ä¸‹ï¼ˆæ¯”å¦‚ 12306 æŠ¢ç¥¨ï¼‰ï¼Œæ‰ä¼šå»è€ƒè™‘æ”¹ä¸º RCã€‚ä¸è¿‡ä¸Šé¢çš„é‚£äº›å†…å®¹ä¹Ÿæ˜¯é¢è¯•ç‹—å®˜çˆ±é—®çš„ã€‚</p>
<h1 id="é—´éš™é”"><a href="#é—´éš™é”" class="headerlink" title="é—´éš™é”"></a>é—´éš™é”</h1><p><strong>é—´éš™é” (Gap Lock)</strong> æ˜¯ MySQL (InnoDB) é‡Œçš„ç‰¹æ€§ï¼Œä¹Ÿæ˜¯<strong>åªæœ‰åœ¨ RRï¼ˆå¯é‡å¤è¯»ï¼‰éš”ç¦»çº§åˆ«ä¸‹</strong>æ‰ä¼šç”Ÿæ•ˆçš„ç‰¹æ®Šé”æœºåˆ¶ã€‚</p>
<p>ä¸éœ€è¦ä¸“é—¨å†™ SQL å»è°ƒç”¨å®ƒã€‚åªè¦éš”ç¦»çº§åˆ«æ˜¯é»˜è®¤çš„ <strong>Repeatable Read (RR)</strong>ï¼Œå¹¶ä¸”æ‰§è¡Œäº†<strong>èŒƒå›´æŸ¥è¯¢çš„åŠ é”æ“ä½œ</strong>ï¼ŒMySQL å°±ä¼šè‡ªåŠ¨è§¦å‘é—´éš™é”ã€‚</p>
<h2 id="å¦‚æœæ²¡æœ‰é—´éš™é”"><a href="#å¦‚æœæ²¡æœ‰é—´éš™é”" class="headerlink" title="å¦‚æœæ²¡æœ‰é—´éš™é”"></a>å¦‚æœæ²¡æœ‰é—´éš™é”</h2><p><strong>åœºæ™¯</strong>ï¼šäº‹åŠ¡Aè¦æŸ¥ ID &gt; 10 çš„æ‰€æœ‰è®¢å•ã€‚ç›®å‰åªæœ‰ ID&#x3D;11, ID&#x3D;13 ä¸¤æ¡ã€‚</p>
<p><strong>åŠ¨ä½œ</strong>ï¼šäº‹åŠ¡Aæ‰§è¡Œ <code>SELECT * FROM orders WHERE id &gt; 10 FOR UPDATE;</code>ï¼ˆé”ä½æŸ¥åˆ°çš„æ•°æ®ï¼‰ã€‚</p>
<p><strong>æ¼æ´</strong>ï¼šå¦‚æœæ²¡æœ‰é—´éš™é”ï¼Œåªé”ä½äº† 11 å’Œ 13ã€‚è¿™æ—¶å€™äº‹åŠ¡Bå·å·<strong>æ’å…¥</strong>äº†ä¸€æ¡ ID&#x3D;12 çš„æ•°æ®ã€‚</p>
<p>ç»“æœï¼šäº‹åŠ¡Aè¿˜æ²¡æäº¤äº‹åŠ¡ï¼Œå†æŸ¥ä¸€æ¬¡ï¼Œå‘ç°çªç„¶å¤šå‡ºæ¥ä¸€ä¸ª 12ï¼è§é¬¼äº†ï¼ˆå¹»è¯»ï¼‰ã€‚<br><strong>é—´éš™é”çš„ä½œç”¨</strong>ï¼š<br>äº‹åŠ¡Aä¸ä»…æŠŠ 11 å’Œ 13 é”ä½ï¼Œè¿˜æ‹‰èµ·äº†<strong>è­¦æˆ’çº¿</strong>â€”â€”<strong>â€œæŠŠ 11 å’Œ 13 ä¸­é—´çš„ç©ºä½ã€13 åé¢çš„ç©ºä½å…¨å°æ­»ï¼è°ä¹Ÿä¸å‡†å¾€é‡Œæ’æ•°æ®ï¼â€</strong></p>
<h2 id="é—´éš™é”çš„å·¥ä½œ"><a href="#é—´éš™é”çš„å·¥ä½œ" class="headerlink" title="é—´éš™é”çš„å·¥ä½œ"></a>é—´éš™é”çš„å·¥ä½œ</h2><p>é¦–å…ˆå…ˆåˆ›å»ºä¸€ä¸ªå¾ˆç®€å•çš„è¡¨</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE TABLE</span> gap_test (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB;</span><br><span class="line"><span class="keyword">INSERT INTO</span> gap_test <span class="keyword">VALUES</span> (<span class="number">1</span>), (<span class="number">5</span>), (<span class="number">10</span>);</span><br></pre></td></tr></table></figure>

<p>åœ¨å…¶ä¸­ä¸€ä¸ªçª—å£å¯åŠ¨äº‹åŠ¡æŸ¥è¯¢é‡Œé¢çš„æ•°æ®</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">MySQL  localhost:3306  mall_db_simple  SQL &gt; START TRANSACTION;</span><br><span class="line">Query OK, 0 rows affected (0.0002 sec)</span><br><span class="line">MySQL  localhost:3306  mall_db_simple  â˜…  SQL &gt; SELECT * FROM gap_test WHERE id &gt; 1 AND id &lt; 10 FOR UPDATE;</span><br><span class="line">+----+</span><br><span class="line">| id |</span><br><span class="line">+----+</span><br><span class="line">|  5 |</span><br><span class="line">+----+</span><br><span class="line">1 row in set (0.0004 sec)</span><br></pre></td></tr></table></figure>

<p>è¿™æ—¶å€™å†åˆ°å¦ä¸€ä¸ªçª—å£å¯åŠ¨äº‹åŠ¡ï¼Œå¹¶å°è¯•å¾€è¿™äº›â€œç©ºä½â€é‡Œæ’æ•°æ®ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">MySQL  localhost:3306  SQL &gt; START TRANSACTION;</span><br><span class="line">Query OK, 0 rows affected (0.0002 sec)</span><br><span class="line">MySQL  localhost:3306  â˜…  SQL &gt; use mall_db_simple;</span><br><span class="line">Default schema set to `mall_db_simple`.</span><br><span class="line">Fetching global names, object names from `mall_db_simple` for auto-completion... Press ^C to stop.</span><br><span class="line">MySQL  localhost:3306  mall_db_simple  â˜…  SQL &gt; INSERT INTO gap_test VALUES (2);</span><br></pre></td></tr></table></figure>

<p>å¡åœ¨è¿™é‡Œä¸åŠ¨äº†ï¼Œå› ä¸ºåœ¨ç¬¬ä¸€ä¸ªçª—å£ MySQL ä¼šè‡ªåŠ¨åŠ ä¸Šé—´éš™é”ï¼Œé”ä½ (1, 5) å’Œ (5, 10) è¿™ä¸¤ä¸ªåŒºé—´</p>
<h2 id="é—´éš™é”å¯¼è‡´çš„æ­»é”"><a href="#é—´éš™é”å¯¼è‡´çš„æ­»é”" class="headerlink" title="é—´éš™é”å¯¼è‡´çš„æ­»é”"></a>é—´éš™é”å¯¼è‡´çš„æ­»é”</h2><ol>
<li><strong>A ç”¨æˆ·</strong>æƒ³æ³¨å†Œåå­—å«â€œå“ˆåŸºç±³â€ï¼Œç”±äºå¹¶å‘é€»è¾‘ï¼Œä»–å…ˆç”¨ <code>SELECT * FROM users WHERE name = &#39;å“ˆåŸºç±³&#39; FOR UPDATE</code> æŸ¥ä¸€ä¸‹æœ‰æ²¡æœ‰ã€‚<ul>
<li>å‡è®¾æ•°æ®åº“é‡Œæ²¡è¿™äººã€‚MySQL åŠ ä¸Šäº†<strong>é—´éš™é”</strong>ï¼ˆé”ä½äº†è¿™ä¸€ç‰‡ä¸å­˜åœ¨çš„åŒºåŸŸï¼‰ã€‚</li>
</ul>
</li>
<li><strong>B ç”¨æˆ·</strong>åŒæ—¶ä¹Ÿæƒ³æ³¨å†Œâ€œå“ˆåŸºç±³â€ï¼Œä¹Ÿæ‰§è¡Œäº†åŒæ ·çš„ SQLã€‚<ul>
<li>é—´éš™é”å’Œé—´éš™é”ä¹‹é—´æ˜¯<strong>ä¸å†²çª</strong>çš„ï¼B ç”¨æˆ·ä¹ŸåŠ ä¸Šäº†é—´éš™é”ã€‚</li>
</ul>
</li>
<li><strong>A ç”¨æˆ·</strong>æ‰§è¡Œ <code>INSERT ... &#39;å“ˆåŸºç±³&#39;</code>ã€‚<ul>
<li><strong>å´©äº†</strong>ï¼šA è¢« B çš„é—´éš™é”æŒ¡ä½äº†ã€‚</li>
</ul>
</li>
<li><strong>B ç”¨æˆ·</strong>æ‰§è¡Œ <code>INSERT ... &#39;å“ˆåŸºç±³&#39;</code>ã€‚<ul>
<li><strong>å´©äº†</strong>ï¼šB è¢« A çš„é—´éš™é”æŒ¡ä½äº†ã€‚</li>
</ul>
</li>
</ol>
<p>MySQL æŠ¥é”™ â€œDeadlock foundâ€ï¼Œå…¶ä¸­ä¸€ä¸ªç”¨æˆ·ç›´æ¥æŠ¥é”™é€€å‡ºã€‚</p>
<p>å¦‚æœä¸éœ€è¦æå…¶ä¸¥æ ¼çš„é˜²å¹»è¯»ï¼ˆå¤§å¤šæ•°äº’è”ç½‘ä¸šåŠ¡éƒ½ä¸éœ€è¦ï¼‰ï¼Œå¯ä»¥é€‰æ‹©æŠŠéš”ç¦»çº§åˆ«é™çº§ä¸º RC (Read Committed)ã€‚åœ¨ RC çº§åˆ«ä¸‹ï¼Œé—´éš™é”ä¼šè‡ªåŠ¨å…³é—­ã€‚è¿™æ ·èƒ½å¤§å¤§å‡å°‘æ­»é”ï¼Œæå‡å¹¶å‘åº¦ã€‚</p>
</article>


<div class="related-wrap" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">è¾ƒæ–°æ–‡ç« </div><a href="/2026/01/04/mysql-higher/">Mysqlæ”»ç•¥-è¿›é˜¶åŠŸèƒ½åˆ°æ›´å¤š</a></div><div class="item" id="next"><div class="note">è¾ƒæ—©æ–‡ç« </div><a href="/2026/01/02/mysql-quick/">Mysqlæ”»ç•¥-å®‰è£…ä½¿ç”¨åˆ°åŸºç¡€çš„å¢åˆ æ”¹æŸ¥</a></div></section></div>






<footer class="page-footer footnote"><hr><div class="text"><p>æœ¬ç«™ç”± <a href="/">å…³å°é›¨</a> ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.33.1">Stellar 1.33.1</a> ä¸»é¢˜åˆ›å»ºã€‚<br><span class="jinrishici-sentence"></span></p>
<script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
</div></footer>
<div class="main-mask" onclick="sidebar.dismiss()"></div></div><aside class="l_right">
<div class="widgets">



<widget class="widget-wrapper toc" id="data-toc" collapse="false"><div class="widget-header dis-select"><span class="name">æœ¬æ–‡ç›®å½•</span><a class="cap-action" onclick="sidebar.toggleTOC()" ><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg></a></div><div class="widget-body"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%87%BD%E6%95%B0"><span class="toc-text">å‡½æ•°</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%86%E7%BB%84%E5%92%8C%E7%BB%9F%E8%AE%A1"><span class="toc-text">åˆ†ç»„å’Œç»Ÿè®¡</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8GROUP-BY%E5%88%86%E7%BB%84"><span class="toc-text">ä½¿ç”¨GROUP BYåˆ†ç»„</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E5%90%88%E5%87%BD%E6%95%B0%E4%BD%BF%E7%94%A8"><span class="toc-text">é…åˆå‡½æ•°ä½¿ç”¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8HAVING%E5%AF%B9%E5%88%86%E7%BB%84%E4%B9%8B%E5%90%8E%E7%9A%84%E7%BB%93%E6%9E%9C%E5%86%8D%E8%BF%87%E6%BB%A4"><span class="toc-text">ä½¿ç”¨HAVINGå¯¹åˆ†ç»„ä¹‹åçš„ç»“æœå†è¿‡æ»¤</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#HAVING%E5%92%8CWHERE%E7%9A%84%E5%8C%BA%E5%88%AB%EF%BC%9F"><span class="toc-text">HAVINGå’ŒWHEREçš„åŒºåˆ«ï¼Ÿ</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%9A%E8%A1%A8%E6%9F%A5%E8%AF%A2"><span class="toc-text">å¤šè¡¨æŸ¥è¯¢</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8JOIN%E8%BF%9B%E8%A1%8C%E5%A4%9A%E8%A1%A8%E6%9F%A5%E8%AF%A2"><span class="toc-text">ä½¿ç”¨JOINè¿›è¡Œå¤šè¡¨æŸ¥è¯¢</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%86%85%E8%BF%9E%E6%8E%A5"><span class="toc-text">ä½¿ç”¨å†…è¿æ¥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%B7%A6%E8%BF%9E%E6%8E%A5"><span class="toc-text">ä½¿ç”¨å·¦è¿æ¥</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%AD%90%E6%9F%A5%E8%AF%A2%E8%BF%9B%E8%A1%8C%E5%A4%9A%E8%A1%A8%E6%9F%A5%E8%AF%A2"><span class="toc-text">ä½¿ç”¨å­æŸ¥è¯¢è¿›è¡Œå¤šè¡¨æŸ¥è¯¢</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95"><span class="toc-text">ç´¢å¼•</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E9%94%AE%E7%B4%A2%E5%BC%95%E6%9C%89%E4%BB%80%E4%B9%88%E7%94%A8%EF%BC%9F"><span class="toc-text">ä¸»é”®ç´¢å¼•æœ‰ä»€ä¹ˆç”¨ï¼Ÿ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%BD%8D%E4%B8%80%E8%A1%8C%E6%95%B0%E6%8D%AE"><span class="toc-text">å®šä½ä¸€è¡Œæ•°æ®</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%B3%E5%AE%9A%E6%95%B0%E6%8D%AE%E5%9C%A8%E7%A3%81%E7%9B%98%E4%B8%8A%E7%9A%84%E7%89%A9%E7%90%86%E9%A1%BA%E5%BA%8F"><span class="toc-text">å†³å®šæ•°æ®åœ¨ç£ç›˜ä¸Šçš„ç‰©ç†é¡ºåº</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%99%AE%E9%80%9A%E7%B4%A2%E5%BC%95%E7%9A%84%E2%80%9C%E6%9C%80%E7%BB%88%E8%90%BD%E8%84%9A%E7%82%B9%E2%80%9D"><span class="toc-text">æ™®é€šç´¢å¼•çš„â€œæœ€ç»ˆè½è„šç‚¹â€</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9E%E8%A1%A8%EF%BC%9F"><span class="toc-text">å›è¡¨ï¼Ÿ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%9B%9E%E8%A1%A8"><span class="toc-text">ä»€ä¹ˆæ˜¯å›è¡¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E4%BC%9A%E5%8F%91%E7%94%9F%E5%9B%9E%E8%A1%A8"><span class="toc-text">ä»€ä¹ˆæ—¶å€™ä¼šå‘ç”Ÿå›è¡¨</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-text">ç´¢å¼•çš„ä½¿ç”¨</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%92%8C%E4%BD%BF%E7%94%A8%E7%B4%A2%E5%BC%95"><span class="toc-text">åˆ›å»ºå’Œä½¿ç”¨ç´¢å¼•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E7%B4%A2%E5%BC%95"><span class="toc-text">åˆ é™¤ç´¢å¼•</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E7%9A%84%E5%89%AF%E4%BD%9C%E7%94%A8"><span class="toc-text">ç´¢å¼•çš„å‰¯ä½œç”¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LIKE%E7%9A%84%E5%9D%91"><span class="toc-text">LIKEçš„å‘</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1"><span class="toc-text">äº‹åŠ¡</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E7%9A%84%E5%85%AB%E8%82%A1"><span class="toc-text">äº‹åŠ¡çš„å…«è‚¡:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E6%8C%87%E4%BB%A4"><span class="toc-text">äº‹åŠ¡æŒ‡ä»¤</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#DELETE%E5%92%8CTRUNCATE%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-text">DELETEå’ŒTRUNCATEçš„åŒºåˆ«</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%80%E5%A7%8B%E4%BA%8B%E5%8A%A1%E4%B9%8B%E5%89%8D"><span class="toc-text">å¼€å§‹äº‹åŠ¡ä¹‹å‰</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%93%E5%AD%98%E6%98%AF%E6%80%8E%E4%B9%88%E8%A2%AB%E4%B8%8B%E5%8D%95%E6%93%8D%E4%BD%9C%E6%90%9E%E4%B9%B1%E7%9A%84%EF%BC%9F"><span class="toc-text">åº“å­˜æ˜¯æ€ä¹ˆè¢«ä¸‹å•æ“ä½œæä¹±çš„ï¼Ÿ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95"><span class="toc-text">è§£å†³æ–¹æ³•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B2%A1%E7%94%A8%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95"><span class="toc-text">æ²¡ç”¨çš„è§£å†³æ–¹æ³•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E6%9E%9C%E8%A6%81%E6%B1%82%E5%BA%93%E5%AD%98%E4%B8%8D%E8%83%BD%E4%B8%BA%E8%B4%9F%E6%95%B0%EF%BC%9F"><span class="toc-text">å¦‚æœè¦æ±‚åº“å­˜ä¸èƒ½ä¸ºè´Ÿæ•°ï¼Ÿ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E4%BA%8B%E5%8A%A1"><span class="toc-text">ä½¿ç”¨äº‹åŠ¡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9E%E6%BB%9A%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-text">å›æ»šçš„ä½¿ç”¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%90%E4%BA%A4%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-text">æäº¤çš„ä½¿ç”¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%9D%E5%AD%98%E7%82%B9%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-text">ä¿å­˜ç‚¹çš„ä½¿ç”¨</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E6%8F%90%E4%BA%A4%EF%BC%9F%E6%89%8B%E5%8A%A8%E6%8F%90%E4%BA%A4%EF%BC%9F"><span class="toc-text">è‡ªåŠ¨æäº¤ï¼Ÿæ‰‹åŠ¨æäº¤ï¼Ÿ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E7%9A%84%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB"><span class="toc-text">äº‹åŠ¡çš„éš”ç¦»çº§åˆ«</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%BB%98%E8%AE%A4%E5%8F%AF%E9%87%8D%E5%A4%8D%E8%AF%BB%E7%9A%84%E5%9C%BA%E6%99%AF"><span class="toc-text">é»˜è®¤å¯é‡å¤è¯»çš„åœºæ™¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E5%B9%B6%E5%8F%91%E6%89%A7%E8%A1%8C%E5%8F%AF%E8%83%BD%E5%BC%95%E5%8F%91%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-text">äº‹åŠ¡å¹¶å‘æ‰§è¡Œå¯èƒ½å¼•å‘çš„é—®é¢˜</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%97%B4%E9%9A%99%E9%94%81"><span class="toc-text">é—´éš™é”</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E6%9E%9C%E6%B2%A1%E6%9C%89%E9%97%B4%E9%9A%99%E9%94%81"><span class="toc-text">å¦‚æœæ²¡æœ‰é—´éš™é”</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%B4%E9%9A%99%E9%94%81%E7%9A%84%E5%B7%A5%E4%BD%9C"><span class="toc-text">é—´éš™é”çš„å·¥ä½œ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%B4%E9%9A%99%E9%94%81%E5%AF%BC%E8%87%B4%E7%9A%84%E6%AD%BB%E9%94%81"><span class="toc-text">é—´éš™é”å¯¼è‡´çš„æ­»é”</span></a></li></ol></li></ol></div><div class="widget-footer"><a class="top" onclick="util.scrollTop()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><!-- Icon from Solar by 480 Design - https://creativecommons.org/licenses/by/4.0/ --><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="1.5"><path stroke-linejoin="round" d="m9 15.5l3-3l3 3m-6-4l3-3l3 3"/><path d="M7 3.338A9.95 9.95 0 0 1 12 2c5.523 0 10 4.477 10 10s-4.477 10-10 10S2 17.523 2 12c0-1.821.487-3.53 1.338-5"/></g></svg><span>å›åˆ°é¡¶éƒ¨</span></a></div></widget>
</div></aside><div class='float-panel'>
  <button type='button' style='display:none' class='laptop-only rightbar-toggle mobile' onclick='sidebar.rightbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg>
  </button>
  <button type='button' style='display:none' class='mobile-only leftbar-toggle mobile' onclick='sidebar.leftbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 11c0-3.771 0-5.657 1.172-6.828C4.343 3 6.229 3 10 3h4c3.771 0 5.657 0 6.828 1.172C22 5.343 22 7.229 22 11v2c0 3.771 0 5.657-1.172 6.828C19.657 21 17.771 21 14 21h-4c-3.771 0-5.657 0-6.828-1.172C2 18.657 2 16.771 2 13z"/><path id="sep" stroke-linecap="round" d="M5.5 10h6m-5 4h4m4.5 7V3"/></g></svg>
  </button>
</div>
</div><div class="scripts">


<script type="text/javascript">
  window.canonical = {"originalHost":null,"officialHosts":["localhost"],"encoded":""};
  const ctx = {
    date_suffix: {
      just: `åˆšåˆš`,
      min: `åˆ†é’Ÿå‰`,
      hour: `å°æ—¶å‰`,
      day: `å¤©å‰`,
    },
    root : `/`,
    tag_plugins: {
      chat: Object.assign({"api":"https://siteinfo.listentothewind.cn/api/v1"}),
    }
  };

  // required plugins (only load if needs)
  if (`local_search`) {
    ctx.search = {};
    ctx.search.service = `local_search`;
    if (ctx.search.service == 'local_search') {
      let service_obj = Object.assign({}, `{"field":"all","path":"/search.json","content":true,"skip_search":[],"codeblock":true,"sort":"-date"}`);
      ctx.search[ctx.search.service] = service_obj;
    }
  }
  const def = {
    avatar: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/3442075.svg`,
    cover: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/cover/76b86c0226ffd.svg`,
    loading: `https://api.iconify.design/eos-icons:three-dots-loading.svg?color=%231cd0fd`,
  };
  const deps = {
    jquery: `https://gcore.jsdelivr.net/npm/jquery@3.7/dist/jquery.min.js`,
    marked: `https://gcore.jsdelivr.net/npm/marked@13.0/lib/marked.umd.min.js`,
    lazyload: `/%5Bobject%20Object%5D`
  }
  

</script>

<script type="text/javascript">
  
  function RunItem() {
    this.list = []; // å­˜æ”¾å›è°ƒå‡½æ•°
    this.start = () => {
      for (var i = 0; i < this.list.length; i++) {
        this.list[i].run();
      }
    };
    this.push = (fn, name, setRequestAnimationFrame = true) => {
      let myfn = fn
      if (setRequestAnimationFrame) {
        myfn = () => {
          utils.requestAnimationFrame(fn)
        }
      }
      var f = new Item(myfn, name);
      this.list.push(f);
    };
    this.remove = (name) => {
      for (let index = 0; index < this.list.length; index++) {
        const e = this.list[index];
        if (e.name == name) {
          this.list.splice(index, 1);
        }
      }
    }
    // æ„é€ ä¸€ä¸ªå¯ä»¥runçš„å¯¹è±¡
    function Item(fn, name) {
      // å‡½æ•°åç§°
      this.name = name || fn.name;
      // runæ–¹æ³•
      this.run = () => {
        try {
          fn()
        } catch (error) {
          console.log(error);
        }
      };
    }
  }

  const utils = {
    // æ‡’åŠ è½½ css https://github.com/filamentgroup/loadCSS
    css: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    js: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      if (src.startsWith('/')) {
        src = ctx.root + src.substring(1);
      }
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // é»˜è®¤å¼‚æ­¥ï¼Œå¦‚æœéœ€è¦åŒæ­¥ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¼ å…¥ {} å³å¯
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function () {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    jq: (fn) => {
      if (typeof jQuery === 'undefined') {
        utils.js(deps.jquery).then(fn)
      } else {
        fn()
      }
    },

    onLoading: (el) => {
      if (el) {
        $(el).append('<div class="loading-wrap"><svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" stroke-opacity=".3" d="M12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="1.3s" values="60;0"/></path><path stroke-dasharray="15" stroke-dashoffset="15" d="M12 3C16.9706 3 21 7.02944 21 12"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.3s" values="15;0"/><animateTransform attributeName="transform" dur="1.5s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/></path></g></svg></div>');
      }
    },
    onLoadSuccess: (el) => {
      if (el) {
        $(el).find('.loading-wrap').remove();
      }
    },
    onLoadFailure: (el) => {
      if (el) {
        $(el).find('.loading-wrap svg').remove();
        $(el).find('.loading-wrap').append('<svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" d="M12 3L21 20H3L12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.5s" values="60;0"/></path><path stroke-dasharray="6" stroke-dashoffset="6" d="M12 10V14"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.6s" dur="0.2s" values="6;0"/></path></g><circle cx="12" cy="17" r="1" fill="currentColor" fill-opacity="0"><animate fill="freeze" attributeName="fill-opacity" begin="0.8s" dur="0.4s" values="0;1"/></circle></svg>');
        $(el).find('.loading-wrap').addClass('error');
      }
    },
    request: (el, url, callback, onFailure) => {
      const maxRetry = 3;
      let retryCount = 0;

      return new Promise((resolve, reject) => {
        const load = () => {
          utils.onLoading?.(el);

          let timedOut = false;
          const timeout = setTimeout(() => {
            timedOut = true;
            console.warn('[request] è¶…æ—¶:', url);

            if (++retryCount >= maxRetry) {
              utils.onLoadFailure?.(el);
              onFailure?.();
              reject('è¯·æ±‚è¶…æ—¶');
            } else {
              setTimeout(load, 1000);
            }
          }, 5000);

          fetch(url).then(resp => {
            if (timedOut) return;
            clearTimeout(timeout);

            if (!resp.ok) throw new Error('å“åº”å¤±è´¥');
            return resp;
          }).then(data => {
            if (timedOut) return;
            utils.onLoadSuccess?.(el);
            callback(data);
            resolve(data);
          }).catch(err => {
            clearTimeout(timeout);
            console.warn('[request] é”™è¯¯:', err);

            if (++retryCount >= maxRetry) {
              utils.onLoadFailure?.(el);
              onFailure?.();
              reject(err);
            } else {
              setTimeout(load, 1000);
            }
          });
        };

        load();
      });
    },
    requestWithoutLoading: (url, options = {}, maxRetry = 2, timeout = 5000) => {
      return new Promise((resolve, reject) => {
        let retryCount = 0;

        const tryRequest = () => {
          let timedOut = false;
          const timer = setTimeout(() => {
            timedOut = true;
            if (++retryCount > maxRetry) reject('timeout');
            else tryRequest();
          }, timeout);

          fetch(url, options)
            .then(resp => {
              clearTimeout(timer);
              if (!resp.ok) throw new Error('bad response');
              resolve(resp);
            })
            .catch(err => {
              clearTimeout(timer);
              if (++retryCount > maxRetry) reject(err);
              else setTimeout(tryRequest, 500);
            });
        };

        tryRequest();
      });
    },
    /********************** requestAnimationFrame ********************************/
    // 1ã€requestAnimationFrame ä¼šæŠŠæ¯ä¸€å¸§ä¸­çš„æ‰€æœ‰ DOM æ“ä½œé›†ä¸­èµ·æ¥ï¼Œåœ¨ä¸€æ¬¡é‡ç»˜æˆ–å›æµä¸­å°±å®Œæˆï¼Œå¹¶ä¸”é‡ç»˜æˆ–å›æµçš„æ—¶é—´é—´éš”ç´§ç´§è·Ÿéšæµè§ˆå™¨çš„åˆ·æ–°é¢‘ç‡ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œè¿™ä¸ªé¢‘ç‡ä¸ºæ¯ç§’60å¸§ã€‚
    // 2ã€åœ¨éšè—æˆ–ä¸å¯è§çš„å…ƒç´ ä¸­ï¼ŒrequestAnimationFrame å°†ä¸ä¼šè¿›è¡Œé‡ç»˜æˆ–å›æµï¼Œè¿™å½“ç„¶å°±æ„å‘³ç€æ›´å°‘çš„çš„ cpuï¼Œgpu å’Œå†…å­˜ä½¿ç”¨é‡ã€‚
    requestAnimationFrame: (fn) => {
      if (!window.requestAnimationFrame) {
        window.requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame;
      }
      window.requestAnimationFrame(fn)
    },
    dark: {},
  };

  // utils.dark.mode å½“å‰æ¨¡å¼ dark or light
  // utils.dark.toggle() æš—é»‘æ¨¡å¼è§¦å‘å™¨
  // utils.dark.push(callBack[,"callBackName"]) ä¼ å…¥è§¦å‘å™¨å›è°ƒå‡½æ•°
  utils.dark.method = {
    toggle: new RunItem(),
  };
  utils.dark = Object.assign(utils.dark, {
    push: utils.dark.method.toggle.push,
  });
</script>
<script>
  const sidebar = {
    leftbar: () => {
      if (l_body) {
        l_body.toggleAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    rightbar: () => {
      if (l_body) {
        l_body.toggleAttribute('rightbar');
        l_body.removeAttribute('leftbar');
      }
    },
    dismiss: () => {
      if (l_body) {
        l_body.removeAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    toggleTOC: () => {
      document.querySelector('#data-toc').classList.toggle('collapse');
    }
  }
</script>
<script type="text/javascript">
  (() => {
    const tagSwitchers = document.querySelectorAll('.tag-subtree.parent-tag > a > .tag-switcher-wrapper')
    for (const tagSwitcher of tagSwitchers) {
      tagSwitcher.addEventListener('click', (e) => {
        const parent = e.target.closest('.tag-subtree.parent-tag')
        parent.classList.toggle('expanded')
        e.preventDefault()
      })
    }

    // Get active tag from query string, then activate it.
    const urlParams = new URLSearchParams(window.location.search)
    const activeTag = urlParams.get('tag')
    if (activeTag) {
      let tag = document.querySelector(`.tag-subtree[data-tag="${activeTag}"]`)
      if (tag) {
        tag.querySelector('a').classList.add('active')
        
        while (tag) {
          tag.classList.add('expanded')
          tag = tag.parentElement.closest('.tag-subtree.parent-tag')
        }
      }
    }
  })()
</script>

<script async src="https://gcore.jsdelivr.net/npm/vanilla-lazyload@19.1/dist/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazy",
    callback_loaded: (el) => {
      el.classList.add('loaded');
      const wrapper = el.closest('.lazy-box');
      const icon = wrapper?.querySelector('.lazy-icon');
      if (icon) icon.remove();
    }
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    window.lazyLoadInstance?.update();
  });

  window.wrapLazyloadImages = (container) => {
    if (typeof container === 'string') {
      container = document.querySelector(container);
    }
    if (!container) return;
    
    const images = container.querySelectorAll('img');
    images.forEach((img) => {
      if (img.classList.contains('lazy')) return;

      const src = img.getAttribute('src');
      if (!src) return;

      const wrapper = document.createElement('div');
      wrapper.className = 'lazy-box';

      const newImg = img.cloneNode();
      newImg.removeAttribute('src');
      newImg.setAttribute('data-src', src);
      newImg.classList.add('lazy');

      const icon = document.createElement('div');
      icon.className = 'lazy-icon';
      if (def.loading) {
        icon.style.backgroundImage = `url("${def.loading}")`;
      }

      wrapper.appendChild(newImg);
      wrapper.appendChild(icon);

      img.replaceWith(wrapper);
    });

    // é€šçŸ¥ LazyLoad æ›´æ–°
    if (window.lazyLoadInstance?.update) {
      window.lazyLoadInstance.update();
    }
  }
  
</script>

<!-- required -->
<script src="/js/main.js?v=1.33.1" defer></script>

<script type="text/javascript">
  const applyTheme = (theme) => {
    if (theme === 'auto') {
      document.documentElement.removeAttribute('data-theme')
    } else {
      document.documentElement.setAttribute('data-theme', theme)
    }

    // applyThemeToGiscus(theme)
  }

  // FIXME: è¿™ä¼šå¯¼è‡´æ— æ³•ä½¿ç”¨ preferred_color_scheme ä»¥å¤–çš„ä¸»é¢˜
  const applyThemeToGiscus = (theme) => {
    // theme = theme === 'auto' ? 'preferred_color_scheme' : theme
    const cmt = document.getElementById('giscus')
    if (cmt) {
      // This works before giscus load.
      cmt.setAttribute('data-theme', theme)
    }

    const iframe = document.querySelector('#comments > section.giscus > iframe')
    if (iframe) {
      // This works after giscus loaded.
      const src = iframe.src
      const newSrc = src.replace(/theme=[\w]+/, `theme=${theme}`)
      iframe.src = newSrc
    }
  }

  const switchTheme = () => {
    // light -> dark -> auto -> light -> ...
    const currentTheme = document.documentElement.getAttribute('data-theme')
    let newTheme;
    switch (currentTheme) {
      case 'light':
        newTheme = 'dark'
        break
      case 'dark':
        newTheme = 'auto'
        break
      default:
        newTheme = 'light'
    }
    applyTheme(newTheme)
    window.localStorage.setItem('Stellar.theme', newTheme)
    utils.dark.mode = newTheme === 'auto' ? (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light") : newTheme;
    utils.dark.method.toggle.start();

    const messages = {
      light: `åˆ‡æ¢åˆ°æµ…è‰²æ¨¡å¼`,
      dark: `åˆ‡æ¢åˆ°æ·±è‰²æ¨¡å¼`,
      auto: `åˆ‡æ¢åˆ°è·Ÿéšç³»ç»Ÿé…è‰²`,
    }
    hud?.toast?.(messages[newTheme])
  }

  (() => {
    // Apply user's preferred theme, if any.
    const theme = window.localStorage.getItem('Stellar.theme')
    if (theme !== null) {
      applyTheme(theme)
    } else {
      utils.dark.mode = window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
    }
    utils.dark.method.toggle.start();
  })()
</script>


<!-- optional -->



<script defer>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.services = Object.assign({}, JSON.parse(`{"mdrender":{"js":"/js/services/mdrender.js"},"siteinfo":{"js":"/js/services/siteinfo.js","api":null},"ghinfo":{"js":"/js/services/ghinfo.js"},"rating":{"js":"/js/services/rating.js","api":"https://star-vote.xaox.cc/api/rating"},"vote":{"js":"/js/services/vote.js","api":"https://star-vote.xaox.cc/api/vote"},"sites":{"js":"/js/services/sites.js"},"friends":{"js":"/js/services/friends.js"},"friends_and_posts":{"js":"/js/services/friends_and_posts.js"},"timeline":{"js":"/js/services/timeline.js"},"fcircle":{"js":"/js/services/fcircle.js"},"weibo":{"js":"/js/services/weibo.js"},"memos":{"js":"/js/services/memos.js"},"voice":{"js":"/js/plugins/voice.js"},"video":{"js":"/js/plugins/video.js"},"download-file":{"js":"/js/plugins/download-file.js"},"twikoo":{"js":"/js/services/twikoo_latest_comment.js"},"waline":{"js":"/js/services/waline_latest_comment.js"},"artalk":{"js":"/js/services/artalk_latest_comment.js"},"giscus":{"js":"/js/services/giscus_latest_comment.js"},"contributors":{"edit_this_page":{"_posts/":null,"wiki/stellar/":"https://github.com/xaoxuu/hexo-theme-stellar-docs/blob/main/"},"js":"/js/services/contributors.js"}}`));
    for (let id of Object.keys(ctx.services)) {
      const js = ctx.services[id].js;
      if (id == 'siteinfo') {
        ctx.cardlinks = document.querySelectorAll('a.link-card[cardlink]');
        if (ctx.cardlinks?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            setCardLink(ctx.cardlinks);
          });
        }
      } else if (id == 'voice') {
        ctx.voiceAudios = document.querySelectorAll('.voice>audio');
        if (ctx.voiceAudios?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            createVoiceDom(ctx.voiceAudios);
          });
        }
      } else if (id == 'video') {
        ctx.videos = document.querySelectorAll('.video>video');
        if (ctx.videos?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            videoEvents(ctx.videos);
          });
        }
      } else if (id == 'download-file') {
        ctx.files = document.querySelectorAll('.file');
        if (ctx.files?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            downloadFileEvent(ctx.files);
          });
        }
      } else {
        const els = document.getElementsByClassName(`ds-${id}`);
        if (els?.length > 0) {
          utils.jq(() => {
            if (id == 'timeline' || 'memos' || 'marked') {
              utils.js(deps.marked).then(function () {
                utils.js(js, { defer: true });
              });
            } else {
              utils.js(js, { defer: true });
            }
          });
        }
      }
    }

    // chat iphone time
    let phoneTimes = document.querySelectorAll('.chat .status-bar .time');

    if (phoneTimes.length > 0) {
      NowTime();
      var date = new Date();
      var sec = date.getSeconds();
      var firstAdjustInterval = setInterval(firstAdjustTime, 1000 * (60 - sec));
    }

    function firstAdjustTime() {
      NowTime();
      clearInterval(firstAdjustInterval);
      setInterval(NowTime, 1000 * 60);
    }

    function NowTime() {
      for (let i = 0; i < phoneTimes.length; ++i) {
        var timeSpan = phoneTimes[i];
        var date = new Date();
        var hour = date.getHours();
        var min = date.getMinutes();
        timeSpan.innerHTML = check(hour) + ":" + check(min);
      }
    };

    function check(val) {
      if (val < 10) {
        return ("0" + val);
      }
      return (val);
    }

    // chat quote
    const chat_quote_obverser = new IntersectionObserver((entries, observer) => {
      entries.filter((entry) => { return entry.isIntersecting }).sort((a, b) => a.intersectionRect.y !== b.intersectionRect.y ? a.intersectionRect.y - b.intersectionRect.y : a.intersectionRect.x - b.intersectionRect.x).forEach((entry, index) => {
          observer.unobserve(entry.target);
          setTimeout(() => {
            entry.target.classList.add('quote-blink');
            setTimeout(() => {
              entry.target.classList.remove('quote-blink');
            }, 1000);
          }, Math.max(100, 16) * (index + 1));
        });
    });

    var chatQuotes = document.querySelectorAll(".chat .talk .quote");
    chatQuotes.forEach((quote) => {
      quote.addEventListener('click', function () {
        var chatCellDom = document.getElementById("quote-" + quote.getAttribute("quotedCellTag"));
        if (chatCellDom) {
          var chatDiv = chatCellDom.parentElement;
          var mid = chatDiv.clientHeight / 2;
          var offsetTop = chatCellDom.offsetTop;
          if (offsetTop > mid - chatCellDom.clientHeight / 2) {
            chatDiv.scrollTo({
              top: chatCellDom.offsetTop - mid + chatCellDom.clientHeight / 2,
              behavior: "smooth"
            });
          } else {
            chatDiv.scrollTo({
              top: 0,
              behavior: "smooth"
            });
          }
          chat_quote_obverser.observe(chatCellDom);
        }
      });
    });
  });
</script>

<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.search = {
      path: `/search.json`,
    }
    utils.js('/js/search/local-search.js', { defer: true });
  });
</script><script>
  window.FPConfig = {
    delay: 0,
    ignoreKeywords: [],
    maxRPS: 5,
    hoverDelay: 25
  };
</script>
<script defer src="https://gcore.jsdelivr.net/npm/flying-pages@2/flying-pages.min.js"></script><script>
  ctx.fancybox = {
    selector: `.timenode p>img`,
    css: `https://gcore.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.css`,
    js: `https://gcore.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.js`
  };
  var selector = '[data-fancybox]:not(.error), .with-fancybox .atk-content img:not([atk-emoticon])';
  if (ctx.fancybox.selector) {
    selector += `, ${ctx.fancybox.selector}`
  }
  var needFancybox = document.querySelectorAll(selector).length !== 0;
  if (!needFancybox) {
    const memos = document.getElementsByClassName('ds-memos');
    if (memos != undefined && memos.length > 0) {
      needFancybox = true;
    }
    const fancybox = document.getElementsByClassName('with-fancybox');
    if (fancybox != undefined && fancybox.length > 0) {
      needFancybox = true;
    }
  }
  if (needFancybox) {
    utils.css(ctx.fancybox.css);
    utils.js(ctx.fancybox.js, { defer: true }).then(function () {
      Fancybox.bind(selector, {
        hideScrollbar: false,
        Thumbs: {
          autoStart: false,
        },
        caption: (fancybox, slide) => {
          return slide.triggerEl.alt || slide.triggerEl.dataset.caption || null
        }
      });
    })
  }
</script>
<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    const swiper_api = document.getElementById('swiper-api');
    if (swiper_api != undefined) {
      utils.css(`https://unpkg.com/swiper@10.3/swiper-bundle.min.css`);
      utils.js(`https://unpkg.com/swiper@10.3/swiper-bundle.min.js`, { defer: true }).then(function () {
        const effect = swiper_api.getAttribute('effect') || '';
        var swiper = new Swiper('.swiper#swiper-api', {
          slidesPerView: 'auto',
          spaceBetween: 8,
          centeredSlides: true,
          effect: effect,
          rewind: true,
          pagination: {
            el: '.swiper-pagination',
            clickable: true,
          },
          navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
          },
        });
      })
    }
  });
</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    window.codeElements = document.querySelectorAll('.code');
    if (window.codeElements.length > 0) {
      ctx.copycode = {
        default_text: `Copy`,
        success_text: `Copied`,
        toast: `å¤åˆ¶æˆåŠŸ`,
      };
      utils.js('/js/plugins/copycode.js');
    }
  });
</script>


<!-- inject -->

</div></body></html>
